<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Http Wasm Middleware | Taction's Blog</title>
<meta name=description content><meta property="og:title" content="Http Wasm Middleware">
<meta property="og:description" content="本文从源码角度分析Dapr Http Wasm的实现原理，以及给出一些常见的使用场景案例。
Dapr runtime middleware dapr将会在初始化的时候调用一次GetHandler这个函数来获取http middleware的构造函数。这里是http middleware构造链式中间件调用的逻辑，与wasm无关，但是是这部分代码应用到middleware一个粘合和基础。
httpMiddlewareLoader.DefaultRegistry.RegisterComponent(func(log logger.Logger) httpMiddlewareLoader.FactoryMethod { return func(metadata middleware.Metadata) (httpMiddleware.Middleware, error) { return wasm.NewMiddleware(log).GetHandler(context.TODO(), metadata) } }, &#34;wasm&#34;) GetHandler会返回一个http中间件函数的构造函数。这个函数的主要作用是解析wasm url，新建一个NewMiddleware。
// GetHandler返回的是http.Handler的一个构造函数。 func (m *middleware) GetHandler(ctx context.Context, metadata dapr.Metadata) (func(next http.Handler) http.Handler, error) { rh, err := m.getHandler(ctx, metadata) if err != nil { return nil, err } return rh.requestHandler, nil } // getHandler 解析metadata配置 func (m *middleware) getHandler(ctx context.Context, metadata dapr.Metadata) (*requestHandler, error) { // Metadata解析目前主要是为了获取wasm bytes。 	meta, err := wasm.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://old.taction.top/dapr/http-wasm-middleware/"><meta property="article:section" content="dapr">
<meta property="article:published_time" content="2023-06-25T22:39:52+08:00">
<meta property="article:modified_time" content="2023-06-25T22:39:52+08:00">
<meta itemprop=name content="Http Wasm Middleware">
<meta itemprop=description content="本文从源码角度分析Dapr Http Wasm的实现原理，以及给出一些常见的使用场景案例。
Dapr runtime middleware dapr将会在初始化的时候调用一次GetHandler这个函数来获取http middleware的构造函数。这里是http middleware构造链式中间件调用的逻辑，与wasm无关，但是是这部分代码应用到middleware一个粘合和基础。
httpMiddlewareLoader.DefaultRegistry.RegisterComponent(func(log logger.Logger) httpMiddlewareLoader.FactoryMethod { return func(metadata middleware.Metadata) (httpMiddleware.Middleware, error) { return wasm.NewMiddleware(log).GetHandler(context.TODO(), metadata) } }, &#34;wasm&#34;) GetHandler会返回一个http中间件函数的构造函数。这个函数的主要作用是解析wasm url，新建一个NewMiddleware。
// GetHandler返回的是http.Handler的一个构造函数。 func (m *middleware) GetHandler(ctx context.Context, metadata dapr.Metadata) (func(next http.Handler) http.Handler, error) { rh, err := m.getHandler(ctx, metadata) if err != nil { return nil, err } return rh.requestHandler, nil } // getHandler 解析metadata配置 func (m *middleware) getHandler(ctx context.Context, metadata dapr.Metadata) (*requestHandler, error) { // Metadata解析目前主要是为了获取wasm bytes。 	meta, err := wasm."><meta itemprop=datePublished content="2023-06-25T22:39:52+08:00">
<meta itemprop=dateModified content="2023-06-25T22:39:52+08:00">
<meta itemprop=wordCount content="1167">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Http Wasm Middleware">
<meta name=twitter:description content="本文从源码角度分析Dapr Http Wasm的实现原理，以及给出一些常见的使用场景案例。
Dapr runtime middleware dapr将会在初始化的时候调用一次GetHandler这个函数来获取http middleware的构造函数。这里是http middleware构造链式中间件调用的逻辑，与wasm无关，但是是这部分代码应用到middleware一个粘合和基础。
httpMiddlewareLoader.DefaultRegistry.RegisterComponent(func(log logger.Logger) httpMiddlewareLoader.FactoryMethod { return func(metadata middleware.Metadata) (httpMiddleware.Middleware, error) { return wasm.NewMiddleware(log).GetHandler(context.TODO(), metadata) } }, &#34;wasm&#34;) GetHandler会返回一个http中间件函数的构造函数。这个函数的主要作用是解析wasm url，新建一个NewMiddleware。
// GetHandler返回的是http.Handler的一个构造函数。 func (m *middleware) GetHandler(ctx context.Context, metadata dapr.Metadata) (func(next http.Handler) http.Handler, error) { rh, err := m.getHandler(ctx, metadata) if err != nil { return nil, err } return rh.requestHandler, nil } // getHandler 解析metadata配置 func (m *middleware) getHandler(ctx context.Context, metadata dapr.Metadata) (*requestHandler, error) { // Metadata解析目前主要是为了获取wasm bytes。 	meta, err := wasm.">
<link rel=preload href=/scss/main.min.a0a8ee9115e3273031f06a4617eb8335b8d0999fb0b44a506bd64d484e7f1593.css as=style>
<link href=/scss/main.min.a0a8ee9115e3273031f06a4617eb8335b8d0999fb0b44a506bd64d484e7f1593.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>Taction's Blog</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section"></a>
</li>
<ul>
<li class="collapse show">
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/dapr/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">dapr</a>
</li>
<ul>
<li class="collapse show" id=dapr>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-daprhttp-wasm-middleware href=/dapr/http-wasm-middleware/>Http Wasm Middleware</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-daprdebug-dapr-k8s href=/dapr/debug-dapr-k8s/>Debug Dapr In K8s</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-daprdeploying-pluggable-k8s href=/dapr/deploying-pluggable-k8s/>Deploying Pluggable K8s</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-daprpluggable-component href=/dapr/pluggable-component/>Pluggable Component</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/spin/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">spin</a>
</li>
<ul>
<li class="collapse show" id=spin>
<a class="td-sidebar-link td-sidebar-link__page" id=m-spinspin-up-sourcecode href=/spin/spin-up-sourcecode/>Spin up 源码分析</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-spinspin-introduction href=/spin/spin-introduction/>Spin介绍</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/serverless/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">serverless</a>
</li>
<ul>
<li class="collapse show" id=serverless>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/serverless/webassembly/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">WebAssembly</a>
</li>
<ul>
<li class="collapse show" id=serverlesswebassembly>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlesswebassemblywasm2 href=/serverless/webassembly/wasm2/>相关项目分析</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlesswebassemblydockerwasmpreview href=/serverless/webassembly/dockerwasmpreview/>docker wasm preview 踩坑指北</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlesswebassemblymanage-wasm-using-docker href=/serverless/webassembly/manage-wasm-using-docker/>using docker manage wasm【译】</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlesswebassemblywasm1 href=/serverless/webassembly/wasm1/>wasm概述</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/serverless/platform/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">platform</a>
</li>
<ul>
<li class="collapse show" id=serverlessplatform>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-demo href=/serverless/platform/knative-demo/>Knative Demo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-queue href=/serverless/platform/knative-queue/>Knative Queue</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-scalefrom0 href=/serverless/platform/knative-scalefrom0/>Knative Scalefrom0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-crd href=/serverless/platform/knative-crd/>Knative Crd</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformdebug-knative href=/serverless/platform/debug-knative/>Debug Knative</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-use href=/serverless/platform/knative-use/>Knative Use</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/wasmcloud/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">wasmcloud</a>
</li>
<ul>
<li class="collapse show" id=wasmcloud>
<a class="td-sidebar-link td-sidebar-link__page" id=m-wasmclouddapr-provider href=/wasmcloud/dapr-provider/>Dapr Provider</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-wasmclouda2acall href=/wasmcloud/a2acall/>Actor to Actor call</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/code/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">code</a>
</li>
<ul>
<li class="collapse show" id=code>
<a class="td-sidebar-link td-sidebar-link__page" id=m-codeacpuquestion href=/code/acpuquestion/>sidecar cpu</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/git/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Gits</a>
</li>
<ul>
<li class="collapse show" id=git>
<a class="td-sidebar-link td-sidebar-link__page" id=m-gitdco-rebase href=/git/dco-rebase/>DCO Rebase</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
</nav>
</div>
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
</div>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#dapr-runtime-middleware>Dapr runtime middleware</a></li>
<li><a href=#http-wasm-host-go>http-wasm-host-go</a></li>
<li><a href=#边界检查>边界检查</a></li>
<li><a href=#使用案例分析>使用案例分析</a></li>
</ul>
</li>
</ul>
</nav>
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=https://old.taction.top/dapr/>dapr</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=https://old.taction.top/dapr/http-wasm-middleware/>Http Wasm Middleware</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>Http Wasm Middleware</h1>
<p>本文从源码角度分析Dapr Http Wasm的实现原理，以及给出一些常见的使用场景案例。</p>
<h3 id=dapr-runtime-middleware>Dapr runtime middleware</h3>
<p>dapr将会在初始化的时候调用一次<code>GetHandler</code>这个函数来获取http middleware的构造函数。这里是http middleware构造链式中间件调用的逻辑，与wasm无关，但是是这部分代码应用到middleware一个粘合和基础。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>httpMiddlewareLoader</span>.<span style=color:#a6e22e>DefaultRegistry</span>.<span style=color:#a6e22e>RegisterComponent</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>log</span> <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Logger</span>) <span style=color:#a6e22e>httpMiddlewareLoader</span>.<span style=color:#a6e22e>FactoryMethod</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>metadata</span> <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>Metadata</span>) (<span style=color:#a6e22e>httpMiddleware</span>.<span style=color:#a6e22e>Middleware</span>, <span style=color:#66d9ef>error</span>) {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>wasm</span>.<span style=color:#a6e22e>NewMiddleware</span>(<span style=color:#a6e22e>log</span>).<span style=color:#a6e22e>GetHandler</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#a6e22e>metadata</span>)
		}
	}, <span style=color:#e6db74>&#34;wasm&#34;</span>)
</code></pre></div><p>GetHandler会返回一个http中间件函数的构造函数。这个函数的主要作用是解析wasm url，新建一个NewMiddleware。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// GetHandler返回的是http.Handler的一个构造函数。
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>middleware</span>) <span style=color:#a6e22e>GetHandler</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>metadata</span> <span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>Metadata</span>) (<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>rh</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>getHandler</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>metadata</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rh</span>.<span style=color:#a6e22e>requestHandler</span>, <span style=color:#66d9ef>nil</span>
}

<span style=color:#75715e>// getHandler 解析metadata配置
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>middleware</span>) <span style=color:#a6e22e>getHandler</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>metadata</span> <span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>Metadata</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>requestHandler</span>, <span style=color:#66d9ef>error</span>) {
  <span style=color:#75715e>// Metadata解析目前主要是为了获取wasm bytes。
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>meta</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>wasm</span>.<span style=color:#a6e22e>GetInitMetadata</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>Base</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;wasm: failed to parse metadata: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
	}

  <span style=color:#75715e>// 主要是为了获取wasm http Middleware实例，以及配置wasm的运行时
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stdout</span>, <span style=color:#a6e22e>stderr</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>
	<span style=color:#a6e22e>mw</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>wasmnethttp</span>.<span style=color:#a6e22e>NewMiddleware</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>Guest</span>,
		<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Logger</span>(<span style=color:#a6e22e>m</span>),
		<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>ModuleConfig</span>(<span style=color:#a6e22e>wazero</span>.<span style=color:#a6e22e>NewModuleConfig</span>().
			<span style=color:#a6e22e>WithName</span>(<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>GuestName</span>).
			<span style=color:#a6e22e>WithStdout</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stdout</span>). <span style=color:#75715e>// reset per request
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>WithStderr</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stderr</span>). <span style=color:#75715e>// reset per request
</span><span style=color:#75715e></span>			<span style=color:#75715e>// The below violate sand-boxing, but allow code to behave as expected.
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>WithRandSource</span>(<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Reader</span>).
			<span style=color:#a6e22e>WithSysNanosleep</span>().
			<span style=color:#a6e22e>WithSysWalltime</span>().
			<span style=color:#a6e22e>WithSysNanosleep</span>()))
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>requestHandler</span>{<span style=color:#a6e22e>mw</span>: <span style=color:#a6e22e>mw</span>, <span style=color:#a6e22e>logger</span>: <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>logger</span>, <span style=color:#a6e22e>stdout</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stdout</span>, <span style=color:#a6e22e>stderr</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stderr</span>}, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>GetHandler的返回值是requestHandler函数。可以看到通过传递给<code>requestHandler</code> <code>http.Handler</code>来构造链式的http路由中间件。也是在这个函数中实际包含wasm中间件的逻辑。通过调用<code>rh.mw.NewHandler</code>方法新建一个实例，调用其<code>ServeHTTP(w, r)</code>对请求进行处理。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rh</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>requestHandler</span>) <span style=color:#a6e22e>requestHandler</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
		<span style=color:#a6e22e>h</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rh</span>.<span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>NewHandler</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#a6e22e>next</span>)
		<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
			<span style=color:#a6e22e>rh</span>.<span style=color:#a6e22e>stdout</span>.<span style=color:#a6e22e>Reset</span>()
			<span style=color:#a6e22e>rh</span>.<span style=color:#a6e22e>stderr</span>.<span style=color:#a6e22e>Reset</span>()
		}()

		<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>)

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>stdout</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rh</span>.<span style=color:#a6e22e>stdout</span>.<span style=color:#a6e22e>String</span>(); len(<span style=color:#a6e22e>stdout</span>) &gt; <span style=color:#ae81ff>0</span> {
			<span style=color:#a6e22e>rh</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;wasm stdout: %s&#34;</span>, <span style=color:#a6e22e>stdout</span>)
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>stderr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rh</span>.<span style=color:#a6e22e>stderr</span>.<span style=color:#a6e22e>String</span>(); len(<span style=color:#a6e22e>stderr</span>) &gt; <span style=color:#ae81ff>0</span> {
			<span style=color:#a6e22e>rh</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;wasm stderr: %s&#34;</span>, <span style=color:#a6e22e>stderr</span>)
		}
	})
}
</code></pre></div><h3 id=http-wasm-host-go>http-wasm-host-go</h3>
<p>实际的wasm host逻辑都在这个库中。在习惯上，会将运行wasm程序的运行时部分称为host，将wasm程序的sdk称为guest。总体思路上来说这个项目为了留出适配其他http框架（例如fasthttp），将逻辑进行了分层处理，与nethttp相关的逻辑比如说生成中间件，设置http上下文都在这个包下。而通用的逻辑处理，比如说实例化wasm程序，调用wasm程序函数，注册host function等都放在了<code>handler</code>包下。了解了这个在查看代码的时候就会对其代码的组织会有更好的了解。在关注具体逻辑之前，先来看一下其目录结构，以及包含的代码逻辑内容。</p>
<h4 id=目录结构>目录结构</h4>
<pre tabindex=0><code>├── api # interface和常量定义
│   └── handler # 主要就是middleware 和host interface
├── examples #例子
├── handler # middleware的通用逻辑及实际执行
│   ├── cstring.go
│   ├── middleware.go # 通用的middleware逻辑定义，host function定义
│   ├── nethttp # 针对不同的实际场景（net.http）适配，针对不同http框架的wrapper
│   │   ├── benchmark_test.go
│   │   ├── buffer.go
│   │   ├── buffer_test.go
│   │   ├── example_test.go
│   │   ├── host.go # host function修改http信息的实际逻辑
│   │   ├── host_test.go
│   │   ├── middleware.go # 针对net http特定的逻辑，是包装在handler/middleware.go外面的适配层。
│   │   ├── middleware_test.go
│   │   └── tck_test.go
│   ├── options.go
│   └── state.go
├── internal # 目前只包含测试
│   └── test
│       └── testdata
│           ├── bench
│           └── e2e
├── tck # technology compatibility kit
│   └── guest
└── testing # 测试
    └── handlertest
</code></pre><p>nethttp wrapper主文件中逻辑其实很简单，外部会使用的逻辑主要集中在两个函数中,在新建handler的时候会将底层middleware的HandleRequest和HandleResponse赋值给自己。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewMiddleware</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>guest</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>options</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Option</span>) (<span style=color:#a6e22e>Middleware</span>, <span style=color:#66d9ef>error</span>) {
  <span style=color:#75715e>// 初始化host function，验证wasmapp正确，然后返回一个base的middleware。
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>NewMiddleware</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>guest</span>, <span style=color:#a6e22e>host</span>{}, <span style=color:#a6e22e>options</span><span style=color:#f92672>...</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>middleware</span>{<span style=color:#a6e22e>m</span>: <span style=color:#a6e22e>m</span>}, <span style=color:#66d9ef>nil</span>
}
<span style=color:#75715e>// NewHandler implements the same method as documented on handler.Middleware.
</span><span style=color:#75715e>// 这里的NewHandler函数就是上文中调用的库函数。这里在新建的时候传入了后续中间件next，形成责任链的链式调用。
</span><span style=color:#75715e>// 另外可以看到在这个地方将request和response的实际处理函数赋值成了底层的通用函数。
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>middleware</span>) <span style=color:#a6e22e>NewHandler</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>next</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>guest</span>{
		<span style=color:#a6e22e>handleRequest</span>:  <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>HandleRequest</span>,
		<span style=color:#a6e22e>handleResponse</span>: <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>HandleResponse</span>,
		<span style=color:#a6e22e>next</span>:           <span style=color:#a6e22e>next</span>,
		<span style=color:#a6e22e>features</span>:       <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Features</span>(),
	}
}
</code></pre></div><p>在处理网络请求的时候首先将http.ResponseWriter、*http.Request、next http.Handler、enabled Features组装成requestState放到context中。然后分别调用HandleRequest、next（handler）、HandleResponse。（requestState是非常重要的一个结构体）。这里的</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// ServeHTTP implements http.Handler
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>guest</span>) <span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#75715e>// The guest Wasm actually handles the request. As it may call host
</span><span style=color:#75715e></span>	<span style=color:#75715e>// functions, we add context parameters of the current request.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newRequestState</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>g</span>)
	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#a6e22e>requestStateKey</span>{}, <span style=color:#a6e22e>s</span>)
	<span style=color:#a6e22e>outCtx</span>, <span style=color:#a6e22e>ctxNext</span>, <span style=color:#a6e22e>requestErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>handleRequest</span>(<span style=color:#a6e22e>ctx</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>requestErr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>handleErr</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>requestErr</span>)
	}

	<span style=color:#75715e>// If buffering was enabled, ensure it flushes.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bw</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>w</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>bufferingResponseWriter</span>); <span style=color:#a6e22e>ok</span> {
		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>release</span>()
	}

	<span style=color:#75715e>// Returning zero means the guest wants to break the handler chain, and
</span><span style=color:#75715e></span>	<span style=color:#75715e>// handle the response directly.
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 这里注意是否继续执行只与next有关，与在handleRequest是否设置了返回无关。也就是说即使设置了返回，那么仍然可以设置继续（虽然这种写法是错误的），响应body就是两者之和，至于header等信息就看具体实现是先设置生效还是后设置生效。
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> uint32(<span style=color:#a6e22e>ctxNext</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// Otherwise, the host calls the next handler.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>handleNext</span>()

	<span style=color:#75715e>// Finally, call the guest with the response or error
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>handleResponse</span>(<span style=color:#a6e22e>outCtx</span>, uint32(<span style=color:#a6e22e>ctxNext</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>32</span>), <span style=color:#a6e22e>err</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#a6e22e>err</span>)
	}
}
</code></pre></div><h5 id=middleware通用逻辑>middleware通用逻辑</h5>
<p>在<code>handler/middleware.go</code>文件中定义了wasm的通用逻辑，获取实例，以及调用wasm中定义的request和response的hander。NewMiddleware包含了host function的注册和wasm的验证。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewMiddleware</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>guest</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>host</span> <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Host</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>Option</span>) (<span style=color:#a6e22e>Middleware</span>, <span style=color:#66d9ef>error</span>) {
  <span style=color:#75715e>// 默认wasm运行时配置，及应用外部传入的配置。
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>o</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>options</span>{
  <span style=color:#a6e22e>newRuntime</span>:   <span style=color:#a6e22e>DefaultRuntime</span>,
		<span style=color:#a6e22e>moduleConfig</span>: <span style=color:#a6e22e>wazero</span>.<span style=color:#a6e22e>NewModuleConfig</span>(),
		<span style=color:#a6e22e>logger</span>:       <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>NoopLogger</span>{},
	}
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>opt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
		<span style=color:#a6e22e>opt</span>(<span style=color:#a6e22e>o</span>)
	}
	<span style=color:#75715e>// runtime实例，默认的是wazero运行时
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>wr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>newRuntime</span>(<span style=color:#a6e22e>ctx</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;wasm: error creating middleware: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
	}

	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>middleware</span>{
		<span style=color:#a6e22e>host</span>:         <span style=color:#a6e22e>host</span>,
		<span style=color:#a6e22e>runtime</span>:      <span style=color:#a6e22e>wr</span>,
		<span style=color:#a6e22e>moduleConfig</span>: <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>moduleConfig</span>,
		<span style=color:#a6e22e>guestConfig</span>:  <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>guestConfig</span>,
		<span style=color:#a6e22e>logger</span>:       <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>logger</span>,
	}
	<span style=color:#75715e>// decode wasm二进制，解析为内存内的数据模式，验证代码需要导出的函数存在且签名正确
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>guestModule</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>compileGuest</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>guest</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>ctx</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
  <span style=color:#75715e>// Detect and handle any host imports or lack thereof.
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 检查用户wasm中的所有的导入定义，看看是否用到了WasiP1或者HttpHandler（也就是本项目模块abi）module。用到了就需要实例化对应的模块并链接。
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>imports</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>detectImports</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>guestModule</span>.<span style=color:#a6e22e>ImportedFunctions</span>())
	<span style=color:#66d9ef>switch</span> {
	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>imports</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>importWasiP1</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>:
    <span style=color:#75715e>// 导入wasi中定义的host function
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>wasi_snapshot_preview1</span>.<span style=color:#a6e22e>Instantiate</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>runtime</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>ctx</span>)
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;wasm: error instantiating wasi: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
		}
		<span style=color:#66d9ef>fallthrough</span> <span style=color:#75715e>// proceed to configure any http_handler imports
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>imports</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>importHttpHandler</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>:
    <span style=color:#75715e>// 注册所有的host function
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>instantiateHost</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>ctx</span>)
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;wasm: error instantiating host: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
		}
	}
	<span style=color:#75715e>// 这里面实例化了一个wasm app，主要执行下初始函数验证下没有错误以尽早发现错误fail-fast。
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>newGuest</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>wr</span>.<span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>ctx</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	} <span style=color:#66d9ef>else</span> {
		<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>g</span>)
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>compileHost就是注册所有的host function。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>middleware</span>) <span style=color:#a6e22e>compileHost</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>wazero</span>.<span style=color:#a6e22e>CompiledModule</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>compiled</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>NewHostModuleBuilder</span>(<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HostModule</span>).
		<span style=color:#a6e22e>NewFunctionBuilder</span>().
		<span style=color:#a6e22e>WithGoFunction</span>(<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>GoFunc</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>enableFeatures</span>), []<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>ValueType</span>{<span style=color:#a6e22e>i32</span>}, []<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>ValueType</span>{<span style=color:#a6e22e>i32</span>}).
		<span style=color:#a6e22e>WithParameterNames</span>(<span style=color:#e6db74>&#34;features&#34;</span>).<span style=color:#a6e22e>Export</span>(<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>FuncEnableFeatures</span>).
		<span style=color:#a6e22e>NewFunctionBuilder</span>().
		<span style=color:#a6e22e>WithGoModuleFunction</span>(<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>GoModuleFunc</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>getConfig</span>), []<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>ValueType</span>{<span style=color:#a6e22e>i32</span>, <span style=color:#a6e22e>i32</span>}, []<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>ValueType</span>{<span style=color:#a6e22e>i32</span>}).
		<span style=color:#a6e22e>WithParameterNames</span>(<span style=color:#e6db74>&#34;buf&#34;</span>, <span style=color:#e6db74>&#34;buf_limit&#34;</span>).<span style=color:#a6e22e>Export</span>(<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>FuncGetConfig</span>).
		<span style=color:#a6e22e>NewFunctionBuilder</span>().
		<span style=color:#a6e22e>WithGoFunction</span>(<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>GoFunc</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>logEnabled</span>), []<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>ValueType</span>{<span style=color:#a6e22e>i32</span>}, []<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>ValueType</span>{<span style=color:#a6e22e>i32</span>}).
		<span style=color:#a6e22e>WithParameterNames</span>(<span style=color:#e6db74>&#34;level&#34;</span>).<span style=color:#a6e22e>Export</span>(<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>FuncLogEnabled</span>).
  <span style=color:#75715e>// 这里就是注册一个set_method这个host函数，这样wasm程序就可以通过调用这个函数来修改http method。
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>NewFunctionBuilder</span>().
		<span style=color:#a6e22e>WithGoModuleFunction</span>(<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>GoModuleFunc</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>setMethod</span>), []<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>ValueType</span>{<span style=color:#a6e22e>i32</span>, <span style=color:#a6e22e>i32</span>}, []<span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>ValueType</span>{}).
		<span style=color:#a6e22e>WithParameterNames</span>(<span style=color:#e6db74>&#34;method&#34;</span>, <span style=color:#e6db74>&#34;method_len&#34;</span>).<span style=color:#a6e22e>Export</span>(<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>FuncSetMethod</span><span style=color:#75715e>/*&#34;set_method&#34;*/</span>).
		<span style=color:#75715e>//......more function
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>Compile</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;wasm: error compiling host: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
	} <span style=color:#66d9ef>else</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>compiled</span>, <span style=color:#66d9ef>nil</span>
	}
}
</code></pre></div><p>以setMethod为例看下一个host function的实现，先吧数据读出来，然后调用host的SetMethod，这里之所以转到host是因为不同的网络框架请求和返回结构体不一样，所以这里实际的设置转到了nethttp下的host。实际的设置是从ctx中把request拿出来然后设置。这里之所以ctx中能拿到也是跟wazero这个运行时有关系，它在所有函数调用不管是host还是wasm都维持了context传递，所以它的状态不用通过全局变量保存，直接通过context传递就可以了。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// getHeader implements the WebAssembly host function handler.FuncSetMethod.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>middleware</span>) <span style=color:#a6e22e>setMethod</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>mod</span> <span style=color:#a6e22e>wazeroapi</span>.<span style=color:#a6e22e>Module</span>, <span style=color:#a6e22e>params</span> []<span style=color:#66d9ef>uint64</span>) {
	<span style=color:#75715e>// 数据指针和数据长度
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>method</span> <span style=color:#f92672>:=</span> uint32(<span style=color:#a6e22e>params</span>[<span style=color:#ae81ff>0</span>])
	<span style=color:#a6e22e>methodLen</span> <span style=color:#f92672>:=</span> uint32(<span style=color:#a6e22e>params</span>[<span style=color:#ae81ff>1</span>])

  <span style=color:#75715e>// 对request的设置都必须在next handler执行之前（不然也没有意义）
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>mustBeforeNext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;set&#34;</span>, <span style=color:#e6db74>&#34;method&#34;</span>)

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>p</span> <span style=color:#66d9ef>string</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>methodLen</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
		panic(<span style=color:#e6db74>&#34;HTTP method cannot be empty&#34;</span>)
	}
  <span style=color:#75715e>// 从wasm的memory中读取数据，这里传入的&#34;method&#34;是打日志用的，真正有意义的是其他三个值。
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>p</span> = <span style=color:#a6e22e>mustReadString</span>(<span style=color:#a6e22e>mod</span>.<span style=color:#a6e22e>Memory</span>(), <span style=color:#e6db74>&#34;method&#34;</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>methodLen</span>)
	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>host</span>.<span style=color:#a6e22e>SetMethod</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>p</span>)
}
<span style=color:#75715e>// SetMethod implements the same method as documented on handler.Host.
</span><span style=color:#75715e>// 实际设置Method函数，从ctx中取出request结构体，进行赋值。
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>host</span>) <span style=color:#a6e22e>SetMethod</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>method</span> <span style=color:#66d9ef>string</span>) {
	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>requestStateFromContext</span>(<span style=color:#a6e22e>ctx</span>).<span style=color:#a6e22e>r</span>
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Method</span> = <span style=color:#a6e22e>method</span>
}
<span style=color:#75715e>// requestStateFromContext就是从ctx中获取到*requestState
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>requestStateFromContext</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>requestState</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>requestStateKey</span>{}).(<span style=color:#f92672>*</span><span style=color:#a6e22e>requestState</span>)
}
</code></pre></div><h3 id=边界检查>边界检查</h3>
<p>对于很多情况都有检查，比如说不能在HandleResponseFn中修改request信息，没有开启<em>FeatureBufferResponse</em>就不能修改来自最终网络调用的返回等。</p>
<p>但是有一些奇怪的行为是可以运行的（但是当你在写这样的代码的时候，你会意识到这是逻辑错误），比如在HandleRequestFn设置response信息，同时next为true去执行后续中间件，最终client得到的body就是两者叠加（是否开启<em>FeatureBufferResponse</em>无影响）。因为这个writer先被HandleRequestFn写了信息，又被来自网络调用写了信息，读的时候自然就都读出来了。例如使用如下的代码</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandleRequestFn</span> = <span style=color:#a6e22e>handleRequest</span>
}

<span style=color:#75715e>// handleRequest serves a static response from the Dapr sidecar.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleRequest</span>(<span style=color:#a6e22e>req</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Response</span>) (<span style=color:#a6e22e>next</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>reqCtx</span> <span style=color:#66d9ef>uint32</span>) {
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Headers</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;text/plain&#34;</span>)
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>().<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;hello &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>GetURI</span>())
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#ae81ff>0</span>
}
</code></pre></div><h3 id=使用案例分析>使用案例分析</h3>
<p>在<a href=https://github.com/Taction/dapr-wasm-example/tree/main/middleware/go>middleware examples</a>中给出了一些使用案例。这里简单罗列下比较常见的几个使用场景：</p>
<h4 id=拦截请求>拦截请求</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;github.com/http-wasm/http-wasm-guest-tinygo/handler&#34;</span>
	<span style=color:#e6db74>&#34;github.com/http-wasm/http-wasm-guest-tinygo/handler/api&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandleRequestFn</span> = <span style=color:#a6e22e>handleRequest</span>
}

<span style=color:#75715e>// handleRequest serves a static response from the Dapr sidecar.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleRequest</span>(<span style=color:#a6e22e>req</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Response</span>) (<span style=color:#a6e22e>next</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>reqCtx</span> <span style=color:#66d9ef>uint32</span>) {
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Headers</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;text/plain&#34;</span>)
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>().<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;Hello, this is wasm middleware, you are requesting: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>GetURI</span>())
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#ae81ff>0</span> <span style=color:#75715e>// do not execute next middleware
</span><span style=color:#75715e></span>}
</code></pre></div><p>在<code>handleRequest</code>函数中可以直接设置网络请求返回，这对通过请求中的某些数据判断拦截请求的场景非常有用。可以注意到<code>handleRequest</code>有两个返回值，分别是代表是否执行后续中间件/请求逻辑布尔类型的next，以及用于上下文保持的uint32类型reqCtx。当拦截请求时next应该返回false。</p>
<h4 id=修改请求返回数据>修改请求返回数据</h4>
<p>用户也可以通过<code>handleResponse</code>函数对请求返回数据进行修改。包括header、body、trailer信息。下面是一个修改返回的例子：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;bytes&#34;</span>
	<span style=color:#e6db74>&#34;github.com/http-wasm/http-wasm-guest-tinygo/handler&#34;</span>
	<span style=color:#e6db74>&#34;github.com/http-wasm/http-wasm-guest-tinygo/handler/api&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Host</span>.<span style=color:#a6e22e>EnableFeatures</span>(<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>FeatureBufferResponse</span>) <span style=color:#75715e>// change response must enable buffer response feature
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandleResponseFn</span> = <span style=color:#a6e22e>handleResponse</span>
}

<span style=color:#75715e>// handleResponse can modify the response
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleResponse</span>(<span style=color:#a6e22e>reqCtx</span> <span style=color:#66d9ef>uint32</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Response</span>, <span style=color:#a6e22e>isError</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#75715e>// get the original response body
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>{}
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>().<span style=color:#a6e22e>WriteTo</span>(<span style=color:#a6e22e>buf</span>)
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Headers</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;text/plain&#34;</span>)
	<span style=color:#75715e>// modify the response body, adding a prefix &#34;hello&#34;
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>().<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;hello &#34;</span>)
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>().<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>Bytes</span>())
}
</code></pre></div><p>这里值得注意的是，如果想要修改返回信息，必须开启<code>BufferRespons</code>功能，如上述代码所示就是在main函数中设置功能开启。在<code>handleResponse</code>函数中可以获取请求和返回的信息，以及设置返回信息。</p>
<h4 id=上下文保持>上下文保持</h4>
<p>在某些场景下，用户可能需要对网络请求数据进行处理，并且在<code>handleResponse</code>阶段仍然能够获取到这些数据。这就可以通过上下文保持的功能来实现：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;github.com/http-wasm/http-wasm-guest-tinygo/handler&#34;</span>
	<span style=color:#e6db74>&#34;github.com/http-wasm/http-wasm-guest-tinygo/handler/api&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Host</span>.<span style=color:#a6e22e>EnableFeatures</span>(<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>FeatureBufferResponse</span>)
	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandleRequestFn</span> = <span style=color:#a6e22e>handleRequest</span>
	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandleResponseFn</span> = <span style=color:#a6e22e>handleResponse</span>
}

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>globalContext</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>uint32</span>]<span style=color:#66d9ef>string</span>)
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>contextCounter</span> <span style=color:#66d9ef>uint32</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleResponse</span>(<span style=color:#a6e22e>reqCtx</span> <span style=color:#66d9ef>uint32</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Response</span>, <span style=color:#a6e22e>isError</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Host</span>.<span style=color:#a6e22e>Log</span>(<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>LogLevelInfo</span>, <span style=color:#e6db74>&#34;handleResponse get uri from context &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>globalContext</span>[<span style=color:#a6e22e>reqCtx</span>])

	<span style=color:#75715e>// Serve response
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Headers</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;text/plain&#34;</span>)
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>SetStatusCode</span>(<span style=color:#ae81ff>200</span>)
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>().<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;Hello &#34;</span>)
	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>().<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>globalContext</span>[<span style=color:#a6e22e>reqCtx</span>])
	<span style=color:#66d9ef>return</span>
}

<span style=color:#75715e>// handleRequest serves a static response from the Dapr sidecar.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleRequest</span>(<span style=color:#a6e22e>req</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>Response</span>) (<span style=color:#a6e22e>next</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>reqCtx</span> <span style=color:#66d9ef>uint32</span>) {
	<span style=color:#a6e22e>contextCounter</span><span style=color:#f92672>++</span>

	<span style=color:#a6e22e>globalContext</span>[<span style=color:#a6e22e>contextCounter</span>] = <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>GetURI</span>()
	<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>Host</span>.<span style=color:#a6e22e>Log</span>(<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>LogLevelInfo</span>, <span style=color:#e6db74>&#34;handleRequest uri: &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>GetURI</span>())
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>contextCounter</span> <span style=color:#75715e>// continue to execute the next middleware
</span><span style=color:#75715e></span>}
</code></pre></div><p>在这个例子中，我们简单的做了一个示例，在<code>handleRequest</code>时将信息设置为与一个uint32类型的值相关联（reqCtx），当<code>handleResponse</code>被执行时这个值会被wasm运行时传入。通过<code>reqCtx</code>可以通过全局map获取到相关的信息。</p>
<div class="text-muted mt-5 pt-3 border-top">
</div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.cea438c454e6f8d67dd37bca384bbf43ecc924d7acf8bff8d36f3eee187503be.js integrity="sha256-zqQ4xFTm+NZ903vKOEu/Q+zJJNes+L/4028+7hh1A74=" crossorigin=anonymous></script>
</body>
</html>