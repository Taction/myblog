<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Knative Scalefrom0 | Taction's Blog</title>
<meta name=description content><meta property="og:title" content="Knative Scalefrom0">
<meta property="og:description" content="本文主要从源码分析角度来看从0开始扩容和缩容到0的过程。主要核心点在于从0开始扩容，主要涉及activator和autoscaler组件。在了解了从0开始扩容之后，自然就会明白缩容到0的时候发生了什么。
概览 当 Pod 缩容到零的时候流量会指到 Activator 上面，Activator 接收到流量以后会主动“通知”Autoscaler 做一个扩容的操作。扩容完成以后 Activator 需要等待第一个 Pod ready 之后才能把流量转发过来。这里在queue上定义了readinessProbe，通过SERVING_READINESS_PROBE环境变量可以设置queue以指定的方式（exec、tcp、http）探活服务容器是否准备好接收流量。
activator监听endpoints（还记得private的service是设置了label selector的吗，k8s会自动创建对应的endpoint）等待服务pod启动完成后，将流量转发给对应的pod。
从0扩容Activator源码分析 本部分主要为了梳理当服务为0副本，请求到达activator的代码运行过程，探究其hold住流量，等待pod启动后转发的机制。所以对于其他未涉及在此流程中的代码暂不进行分析。
这个流程中的一些关键节点大概可以整理成下图：
指标上报到autoscaler 目标服务解析 activator从请求 header Knative-Serving-Namespace、Knative-Serving-Revision分别解析出来服务所在的namespace和revision，这两个header值是在定义kingress的时候设置的appendHeaders选项定义的，由网关自动附加。
如果这两个header值任意一个为空，那么就获取访问host，按照${name}.${namespace}.svc.${clusterdomain}的形式尝试解析host获取上述两个值。
然后尝试获取revision的详细定义，并将信息附着到context中。
后续是一系列中间件的处理，其中pkg/activator/handler/tracing_handler.go是trace的处理。
流量指标统计与上报 在pkg/activator/handler/concurrency_reporter.go文件中定义了Handler路由中间件方法，此方法主要是为了统计流量和并发数量，同时也在对应服务没有副本的时候触发向autoscaler上报的行为。
// Handler returns a handler that records requests coming in/being finished in the stats // machinery. func (cr *ConcurrencyReporter) Handler(next http.Handler) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { revisionKey := RevIDFrom(r.Context()) stat := cr.handleRequestIn(network.ReqEvent{Key: revisionKey, Type: network.ReqIn, Time: time.Now()}) defer func() { // 主要是将并发数量-1  cr.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://taction.top/serverless/platform/knative-scalefrom0/"><meta property="article:section" content="serverless">
<meta property="article:published_time" content="2021-12-01T15:44:10+08:00">
<meta property="article:modified_time" content="2021-12-01T15:44:10+08:00">
<meta itemprop=name content="Knative Scalefrom0">
<meta itemprop=description content="本文主要从源码分析角度来看从0开始扩容和缩容到0的过程。主要核心点在于从0开始扩容，主要涉及activator和autoscaler组件。在了解了从0开始扩容之后，自然就会明白缩容到0的时候发生了什么。
概览 当 Pod 缩容到零的时候流量会指到 Activator 上面，Activator 接收到流量以后会主动“通知”Autoscaler 做一个扩容的操作。扩容完成以后 Activator 需要等待第一个 Pod ready 之后才能把流量转发过来。这里在queue上定义了readinessProbe，通过SERVING_READINESS_PROBE环境变量可以设置queue以指定的方式（exec、tcp、http）探活服务容器是否准备好接收流量。
activator监听endpoints（还记得private的service是设置了label selector的吗，k8s会自动创建对应的endpoint）等待服务pod启动完成后，将流量转发给对应的pod。
从0扩容Activator源码分析 本部分主要为了梳理当服务为0副本，请求到达activator的代码运行过程，探究其hold住流量，等待pod启动后转发的机制。所以对于其他未涉及在此流程中的代码暂不进行分析。
这个流程中的一些关键节点大概可以整理成下图：
指标上报到autoscaler 目标服务解析 activator从请求 header Knative-Serving-Namespace、Knative-Serving-Revision分别解析出来服务所在的namespace和revision，这两个header值是在定义kingress的时候设置的appendHeaders选项定义的，由网关自动附加。
如果这两个header值任意一个为空，那么就获取访问host，按照${name}.${namespace}.svc.${clusterdomain}的形式尝试解析host获取上述两个值。
然后尝试获取revision的详细定义，并将信息附着到context中。
后续是一系列中间件的处理，其中pkg/activator/handler/tracing_handler.go是trace的处理。
流量指标统计与上报 在pkg/activator/handler/concurrency_reporter.go文件中定义了Handler路由中间件方法，此方法主要是为了统计流量和并发数量，同时也在对应服务没有副本的时候触发向autoscaler上报的行为。
// Handler returns a handler that records requests coming in/being finished in the stats // machinery. func (cr *ConcurrencyReporter) Handler(next http.Handler) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { revisionKey := RevIDFrom(r.Context()) stat := cr.handleRequestIn(network.ReqEvent{Key: revisionKey, Type: network.ReqIn, Time: time.Now()}) defer func() { // 主要是将并发数量-1  cr."><meta itemprop=datePublished content="2021-12-01T15:44:10+08:00">
<meta itemprop=dateModified content="2021-12-01T15:44:10+08:00">
<meta itemprop=wordCount content="5674">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Knative Scalefrom0">
<meta name=twitter:description content="本文主要从源码分析角度来看从0开始扩容和缩容到0的过程。主要核心点在于从0开始扩容，主要涉及activator和autoscaler组件。在了解了从0开始扩容之后，自然就会明白缩容到0的时候发生了什么。
概览 当 Pod 缩容到零的时候流量会指到 Activator 上面，Activator 接收到流量以后会主动“通知”Autoscaler 做一个扩容的操作。扩容完成以后 Activator 需要等待第一个 Pod ready 之后才能把流量转发过来。这里在queue上定义了readinessProbe，通过SERVING_READINESS_PROBE环境变量可以设置queue以指定的方式（exec、tcp、http）探活服务容器是否准备好接收流量。
activator监听endpoints（还记得private的service是设置了label selector的吗，k8s会自动创建对应的endpoint）等待服务pod启动完成后，将流量转发给对应的pod。
从0扩容Activator源码分析 本部分主要为了梳理当服务为0副本，请求到达activator的代码运行过程，探究其hold住流量，等待pod启动后转发的机制。所以对于其他未涉及在此流程中的代码暂不进行分析。
这个流程中的一些关键节点大概可以整理成下图：
指标上报到autoscaler 目标服务解析 activator从请求 header Knative-Serving-Namespace、Knative-Serving-Revision分别解析出来服务所在的namespace和revision，这两个header值是在定义kingress的时候设置的appendHeaders选项定义的，由网关自动附加。
如果这两个header值任意一个为空，那么就获取访问host，按照${name}.${namespace}.svc.${clusterdomain}的形式尝试解析host获取上述两个值。
然后尝试获取revision的详细定义，并将信息附着到context中。
后续是一系列中间件的处理，其中pkg/activator/handler/tracing_handler.go是trace的处理。
流量指标统计与上报 在pkg/activator/handler/concurrency_reporter.go文件中定义了Handler路由中间件方法，此方法主要是为了统计流量和并发数量，同时也在对应服务没有副本的时候触发向autoscaler上报的行为。
// Handler returns a handler that records requests coming in/being finished in the stats // machinery. func (cr *ConcurrencyReporter) Handler(next http.Handler) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { revisionKey := RevIDFrom(r.Context()) stat := cr.handleRequestIn(network.ReqEvent{Key: revisionKey, Type: network.ReqIn, Time: time.Now()}) defer func() { // 主要是将并发数量-1  cr.">
<link rel=preload href=/scss/main.min.7deef606a7f12d3311a44ac414730e6af0a760f211628cf17f32e0fbcf9a06e9.css as=style>
<link href=/scss/main.min.7deef606a7f12d3311a44ac414730e6af0a760f211628cf17f32e0fbcf9a06e9.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=font-weight-bold>Taction's Blog</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section"></a>
</li>
<ul>
<li class="collapse show">
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/spin/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">spin</a>
</li>
<ul>
<li class="collapse show" id=spin>
<a class="td-sidebar-link td-sidebar-link__page" id=m-spinspin-up-sourcecode href=/spin/spin-up-sourcecode/>Spin up 源码分析</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-spinspin-introduction href=/spin/spin-introduction/>Spin介绍</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/serverless/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">serverless</a>
</li>
<ul>
<li class="collapse show" id=serverless>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/serverless/webassembly/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">WebAssembly</a>
</li>
<ul>
<li class="collapse show" id=serverlesswebassembly>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlesswebassemblywasm2 href=/serverless/webassembly/wasm2/>相关项目分析</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlesswebassemblydockerwasmpreview href=/serverless/webassembly/dockerwasmpreview/>docker wasm preview 踩坑指北</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlesswebassemblymanage-wasm-using-docker href=/serverless/webassembly/manage-wasm-using-docker/>using docker manage wasm【译】</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlesswebassemblywasm1 href=/serverless/webassembly/wasm1/>wasm概述</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/serverless/platform/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">platform</a>
</li>
<ul>
<li class="collapse show" id=serverlessplatform>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-demo href=/serverless/platform/knative-demo/>Knative Demo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-queue href=/serverless/platform/knative-queue/>Knative Queue</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-serverlessplatformknative-scalefrom0 href=/serverless/platform/knative-scalefrom0/>Knative Scalefrom0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-crd href=/serverless/platform/knative-crd/>Knative Crd</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformdebug-knative href=/serverless/platform/debug-knative/>Debug Knative</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-serverlessplatformknative-use href=/serverless/platform/knative-use/>Knative Use</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/wasmcloud/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">wasmcloud</a>
</li>
<ul>
<li class="collapse show" id=wasmcloud>
<a class="td-sidebar-link td-sidebar-link__page" id=m-wasmclouddapr-provider href=/wasmcloud/dapr-provider/>Dapr Provider</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-wasmclouda2acall href=/wasmcloud/a2acall/>Actor to Actor call</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/code/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">code</a>
</li>
<ul>
<li class="collapse show" id=code>
<a class="td-sidebar-link td-sidebar-link__page" id=m-codeacpuquestion href=/code/acpuquestion/>sidecar cpu</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/dapr/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">dapr</a>
</li>
<ul>
<li class="collapse show" id=dapr>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/git/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Gits</a>
</li>
<ul>
<li class="collapse show" id=git>
<a class="td-sidebar-link td-sidebar-link__page" id=m-gitdco-rebase href=/git/dco-rebase/>DCO Rebase</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
</nav>
</div>
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
</div>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#概览>概览</a></li>
<li><a href=#从0扩容activator源码分析>从0扩容Activator源码分析</a></li>
<li><a href=#从0扩容autoscaler源码分析>从0扩容autoscaler源码分析</a></li>
</ul>
</li>
</ul>
</nav>
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=https://taction.top/serverless/>serverless</a>
</li>
<li class=breadcrumb-item>
<a href=https://taction.top/serverless/platform/>platform</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=https://taction.top/serverless/platform/knative-scalefrom0/>Knative Scalefrom0</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>Knative Scalefrom0</h1>
<p>本文主要从源码分析角度来看从0开始扩容和缩容到0的过程。主要核心点在于从0开始扩容，主要涉及activator和autoscaler组件。在了解了从0开始扩容之后，自然就会明白缩容到0的时候发生了什么。</p>
<h3 id=概览>概览</h3>
<p>当 Pod 缩容到零的时候流量会指到 Activator 上面，Activator 接收到流量以后会主动“通知”Autoscaler 做一个扩容的操作。扩容完成以后 Activator 需要等待第一个 Pod ready 之后才能把流量转发过来。这里在queue上定义了<code>readinessProbe</code>，通过<code>SERVING_READINESS_PROBE</code>环境变量可以设置queue以指定的方式（exec、tcp、http）探活服务容器是否准备好接收流量。</p>
<p>activator监听endpoints（还记得private的service是设置了label selector的吗，k8s会自动创建对应的endpoint）等待服务pod启动完成后，将流量转发给对应的pod。</p>
<p><img src=https://image-1255620078.cos.ap-nanjing.myqcloud.com/image-20211201172212727.png alt=image-20211201172212727></p>
<h3 id=从0扩容activator源码分析>从0扩容Activator源码分析</h3>
<p>本部分主要为了梳理当服务为0副本，请求到达activator的代码运行过程，探究其hold住流量，等待pod启动后转发的机制。所以对于其他未涉及在此流程中的代码暂不进行分析。</p>
<p>这个流程中的一些关键节点大概可以整理成下图：</p>
<p><img src=https://image-1255620078.cos.ap-nanjing.myqcloud.com/image-20211202132258697.png alt=image-20211202132258697></p>
<h4 id=指标上报到autoscaler>指标上报到autoscaler</h4>
<h5 id=目标服务解析>目标服务解析</h5>
<p>activator从请求 header <code>Knative-Serving-Namespace</code>、<code>Knative-Serving-Revision</code>分别解析出来服务所在的namespace和revision，这两个header值是在定义kingress的时候设置的<code>appendHeaders</code>选项定义的，由网关自动附加。</p>
<p>如果这两个header值任意一个为空，那么就获取访问host，按照${name}.${namespace}.svc.${clusterdomain}的形式尝试解析host获取上述两个值。</p>
<p>然后尝试获取revision的详细定义，并将信息附着到context中。</p>
<p>后续是一系列中间件的处理，其中pkg/activator/handler/tracing_handler.go是trace的处理。</p>
<h5 id=流量指标统计与上报>流量指标统计与上报</h5>
<p>在<code>pkg/activator/handler/concurrency_reporter.go</code>文件中定义了Handler路由中间件方法，此方法主要是为了统计流量和并发数量，同时也在对应服务没有副本的时候触发向autoscaler上报的行为。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Handler returns a handler that records requests coming in/being finished in the stats
</span><span style=color:#75715e>// machinery.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConcurrencyReporter</span>) <span style=color:#a6e22e>Handler</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span> {
   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
      <span style=color:#a6e22e>revisionKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RevIDFrom</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>())

      <span style=color:#a6e22e>stat</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>handleRequestIn</span>(<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>ReqEvent</span>{<span style=color:#a6e22e>Key</span>: <span style=color:#a6e22e>revisionKey</span>, <span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>ReqIn</span>, <span style=color:#a6e22e>Time</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()})
      <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
         <span style=color:#75715e>// 主要是将并发数量-1
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>handleRequestOut</span>(<span style=color:#a6e22e>stat</span>, <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>ReqEvent</span>{<span style=color:#a6e22e>Key</span>: <span style=color:#a6e22e>revisionKey</span>, <span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>ReqOut</span>, <span style=color:#a6e22e>Time</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()})
      }()

      <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>)
   }
}
</code></pre></div><p><code>handleRequestIn</code>定义在<code>pkg/activator/handler/context_handler.go</code>文件中这个函数中其主要行为就是调用<code>getOrCreateStat</code>函数，如果这个服务没有pod，那么msg就不为nil，而将msg发送到<code>cr.statCh</code>后，最终会通过websocket发送给autoscaler，autoscaler会根据其中的revision信息（namespace + name）来最终触发扩容操作。</p>
<p>接下来是<code>pkg/activator/handler/concurrency_reporter.go</code>的处理，如果是某个服务第一次被请求，那么会将这个信息发到<code>statCh</code>，它的处理在<code>pkg/activator/stat_reporter.go</code>中就是将指标数据结构转换一下，通过vendor中<code>knative.dev/pkg/websocket/connection.go</code>封装的websocket发送到autoscaler中。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// handleRequestIn handles an event of a request coming into the system. Returns the stats
</span><span style=color:#75715e>// the outgoing event should be recorded to.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConcurrencyReporter</span>) <span style=color:#a6e22e>handleRequestIn</span>(<span style=color:#a6e22e>event</span> <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>ReqEvent</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionStats</span> {
   <span style=color:#75715e>// 只有是第一次请求的时候才会有msg这个信息。后续会发往activator触发扩容。
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>stat</span>, <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>getOrCreateStat</span>(<span style=color:#a6e22e>event</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>statCh</span> <span style=color:#f92672>&lt;-</span> []<span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>StatMessage</span>{<span style=color:#f92672>*</span><span style=color:#a6e22e>msg</span>}
   }
 <span style=color:#75715e>// 记录并发数量+1，记录请求数量+1.请求结束时也会调用下面逻辑，并发数量会在请求结束时被减掉。
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>stat</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>HandleEvent</span>(<span style=color:#a6e22e>event</span>)
   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>stat</span>
}
</code></pre></div><p>如果当前map中无revision对应的state，就返回一个StatMessage来将状态上报给autoscaler从而触发从0扩容，这一部分在后面会详细介绍，接下来让我们先继续往下看。如果有对应的state就将refs++。注意这里的一个常见的并发场景使用锁的方式，在第一次取的时候用的读锁，且手动释放。第二次使用写锁，且第一步同样是检查是否存在。</p>
<p>state对应的指标也会通过prometheus指标方式暴露出去，供autoscaler获取。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// getOrCreateStat gets a stat from the state if present.
</span><span style=color:#75715e>// If absent it creates a new one and returns it, potentially returning a StatMessage too
</span><span style=color:#75715e>// to trigger an immediate scale-from-0.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConcurrencyReporter</span>) <span style=color:#a6e22e>getOrCreateStat</span>(<span style=color:#a6e22e>event</span> <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>ReqEvent</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>revisionStats</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>StatMessage</span>) {
	<span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>RLock</span>()
	<span style=color:#a6e22e>stat</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>stats</span>[<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Key</span>]
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>stat</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#75715e>// Since this is incremented under the lock, it&#39;s guaranteed to be observed by
</span><span style=color:#75715e></span>		<span style=color:#75715e>// the deletion routine.
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>stat</span>.<span style=color:#a6e22e>refs</span>.<span style=color:#a6e22e>Inc</span>()
		<span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>RUnlock</span>()
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>stat</span>, <span style=color:#66d9ef>nil</span>
	}
	<span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>RUnlock</span>()

	<span style=color:#75715e>// Doubly checked locking.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Unlock</span>()

	<span style=color:#a6e22e>stat</span> = <span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>stats</span>[<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Key</span>]
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>stat</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#75715e>// Since this is incremented under the lock, it&#39;s guaranteed to be observed by
</span><span style=color:#75715e></span>		<span style=color:#75715e>// the deletion routine.
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>stat</span>.<span style=color:#a6e22e>refs</span>.<span style=color:#a6e22e>Inc</span>()
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>stat</span>, <span style=color:#66d9ef>nil</span>
	}

	<span style=color:#a6e22e>stat</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>revisionStats</span>{
		<span style=color:#a6e22e>stats</span>:        <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>NewRequestStats</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Time</span>),
		<span style=color:#a6e22e>firstRequest</span>: <span style=color:#ae81ff>1</span>,
	}
	<span style=color:#a6e22e>stat</span>.<span style=color:#a6e22e>refs</span>.<span style=color:#a6e22e>Inc</span>()
	<span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>stats</span>[<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Key</span>] = <span style=color:#a6e22e>stat</span>

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>stat</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>StatMessage</span>{
		<span style=color:#75715e>// 这里是被请求服务的Namespace和版本Name
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>Key</span>: <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Key</span>,
		<span style=color:#a6e22e>Stat</span>: <span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>Stat</span>{
		  <span style=color:#75715e>// 这个是activator自己的实际pod名称。
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>PodName</span>:                   <span style=color:#a6e22e>cr</span>.<span style=color:#a6e22e>podName</span>,
			<span style=color:#a6e22e>AverageConcurrentRequests</span>: <span style=color:#ae81ff>1</span>,
			<span style=color:#75715e>// The way the checks are written, this cannot ever be
</span><span style=color:#75715e></span>			<span style=color:#75715e>// anything else but 1. The stats map key is only deleted
</span><span style=color:#75715e></span>			<span style=color:#75715e>// after a reporting period, so we see this code path at most
</span><span style=color:#75715e></span>			<span style=color:#75715e>// once per period.
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>RequestCount</span>: <span style=color:#ae81ff>1</span>,
		},
	}
}
</code></pre></div><h4 id=阻塞等待扩容完成>阻塞等待扩容完成</h4>
<h5 id=实际流量的处理>实际流量的处理</h5>
<p>经过各个中间件流程后，最后走到<code>pkg/activator/handler/handler.go</code>中等待pod启动并转发。主要的等待pod启动的逻辑是在<code>a.throttler.Try</code>中进行处理的。等待pod启动后会调用传入的func</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>activationHandler</span>) <span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
   <span style=color:#a6e22e>config</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>activatorconfig</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>())
   <span style=color:#a6e22e>tracingEnabled</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Tracing</span>.<span style=color:#a6e22e>Backend</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>tracingconfig</span>.<span style=color:#a6e22e>None</span>

   <span style=color:#a6e22e>tryContext</span>, <span style=color:#a6e22e>trySpan</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), (<span style=color:#f92672>*</span><span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Span</span>)(<span style=color:#66d9ef>nil</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tracingEnabled</span> {
      <span style=color:#a6e22e>tryContext</span>, <span style=color:#a6e22e>trySpan</span> = <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>StartSpan</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#e6db74>&#34;throttler_try&#34;</span>)
   }

   <span style=color:#a6e22e>revID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RevIDFrom</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>())
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>throttler</span>.<span style=color:#a6e22e>Try</span>(<span style=color:#a6e22e>tryContext</span>, <span style=color:#a6e22e>revID</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>dest</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
      <span style=color:#75715e>// 当pod被启动后，即会执行此函数的内部逻辑，对请求进行转发
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>trySpan</span>.<span style=color:#a6e22e>End</span>()

      <span style=color:#a6e22e>proxyCtx</span>, <span style=color:#a6e22e>proxySpan</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), (<span style=color:#f92672>*</span><span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Span</span>)(<span style=color:#66d9ef>nil</span>)
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tracingEnabled</span> {
         <span style=color:#a6e22e>proxyCtx</span>, <span style=color:#a6e22e>proxySpan</span> = <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>StartSpan</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#e6db74>&#34;activator_proxy&#34;</span>)
      }
      <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>proxyRequest</span>(<span style=color:#a6e22e>revID</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>proxyCtx</span>), <span style=color:#a6e22e>dest</span>, <span style=color:#a6e22e>tracingEnabled</span>, <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>usePassthroughLb</span>)
      <span style=color:#a6e22e>proxySpan</span>.<span style=color:#a6e22e>End</span>()

      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
   }); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#75715e>// Set error on our capacity waiting span and end it.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>trySpan</span>.<span style=color:#a6e22e>Annotate</span>([]<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Attribute</span>{<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>StringAttribute</span>(<span style=color:#e6db74>&#34;activator.throttler.error&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())}, <span style=color:#e6db74>&#34;ThrottlerTry&#34;</span>)
      <span style=color:#a6e22e>trySpan</span>.<span style=color:#a6e22e>End</span>()

      <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;Throttler try error&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>logkey</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>revID</span>.<span style=color:#a6e22e>String</span>()), <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))

      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>DeadlineExceeded</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>ErrRequestQueueFull</span>) {
         <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>)
      } <span style=color:#66d9ef>else</span> {
         <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
      }
   }
}
</code></pre></div><p>try函数循环处理一直会等待到pod启动后执行func逻辑。<code>rt.breaker.Maybe</code>是等待pod启动的关键。pod启动后会尝试获取目标地址，并且循环尝试，获取到地址之后，调用传入func，在上面函数中完成对请求的转发。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionThrottler</span>) <span style=color:#a6e22e>try</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>function</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
   <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ret</span> <span style=color:#66d9ef>error</span>

   <span style=color:#75715e>// Retrying infinitely as long as we receive no dest. Outer semaphore and inner
</span><span style=color:#75715e></span>   <span style=color:#75715e>// pod capacity are not changed atomically, hence they can race each other. We
</span><span style=color:#75715e></span>   <span style=color:#75715e>// &#34;reenqueue&#34; requests should that happen.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>reenqueue</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>true</span>
   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>reenqueue</span> {
      <span style=color:#a6e22e>reenqueue</span> = <span style=color:#66d9ef>false</span>
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>Maybe</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#66d9ef>func</span>() {
         <span style=color:#a6e22e>cb</span>, <span style=color:#a6e22e>tracker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>acquireDest</span>(<span style=color:#a6e22e>ctx</span>)
         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tracker</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#75715e>// This can happen if individual requests raced each other or if pod
</span><span style=color:#75715e></span>            <span style=color:#75715e>// capacity was decreased after passing the outer semaphore.
</span><span style=color:#75715e></span>            <span style=color:#a6e22e>reenqueue</span> = <span style=color:#66d9ef>true</span>
            <span style=color:#66d9ef>return</span>
         }
         <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cb</span>()
         <span style=color:#75715e>// We already reserved a guaranteed spot. So just execute the passed functor.
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>ret</span> = <span style=color:#a6e22e>function</span>(<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>dest</span>)
      }); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
      }
   }
   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ret</span>
}
</code></pre></div><p>maybe函数主要是检查是否activator hold住的请求数量达到配置上限，如果达到了就直接丢弃。否则调用<code> b.sem.acquire(ctx)</code>阻塞等待信号量。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Maybe conditionally executes thunk based on the Breaker concurrency
</span><span style=color:#75715e>// and queue parameters. If the concurrency limit and queue capacity are
</span><span style=color:#75715e>// already consumed, Maybe returns immediately without calling thunk. If
</span><span style=color:#75715e>// the thunk was executed, Maybe returns nil, else error.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Breaker</span>) <span style=color:#a6e22e>Maybe</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>thunk</span> <span style=color:#66d9ef>func</span>()) <span style=color:#66d9ef>error</span> {
   <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>tryAcquirePending</span>() {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrRequestQueueFull</span>
   }

   <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>releasePending</span>()

   <span style=color:#75715e>// Wait for capacity in the active queue.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>acquire</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
   }
   <span style=color:#75715e>// Defer releasing capacity in the active.
</span><span style=color:#75715e></span>   <span style=color:#75715e>// It&#39;s safe to ignore the error returned by release since we
</span><span style=color:#75715e></span>   <span style=color:#75715e>// make sure the semaphore is only manipulated here and acquire
</span><span style=color:#75715e></span>   <span style=color:#75715e>// + release calls are equally paired.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>release</span>()

   <span style=color:#75715e>// Do the thing.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>thunk</span>()
   <span style=color:#75715e>// Report success
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>在acquire中可以看到其在等待<code>s.queue</code>这个通道。那么是谁向这个通道发送的数据呢？在什么情况下发送的数据？实际上这个通道的数据处理是另外一个协程进行的，在服务副本数为0的时候会初始化这个通道，在服务副本数大于0的时候会直接关闭这个通道。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// acquire acquires capacity from the semaphore.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>semaphore</span>) <span style=color:#a6e22e>acquire</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
   <span style=color:#66d9ef>for</span> {
      <span style=color:#a6e22e>old</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Load</span>()
      <span style=color:#a6e22e>capacity</span>, <span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unpack</span>(<span style=color:#a6e22e>old</span>)

      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>in</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>capacity</span> {
         <span style=color:#66d9ef>select</span> {
         <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
         <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>queue</span>:
         }
         <span style=color:#75715e>// Force reload state.
</span><span style=color:#75715e></span>         <span style=color:#66d9ef>continue</span>
      }

      <span style=color:#a6e22e>in</span><span style=color:#f92672>++</span>
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>CAS</span>(<span style=color:#a6e22e>old</span>, <span style=color:#a6e22e>pack</span>(<span style=color:#a6e22e>capacity</span>, <span style=color:#a6e22e>in</span>)) {
         <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
      }
   }
}
</code></pre></div><h4 id=感知副本数量变化>感知副本数量变化</h4>
<h5 id=副本数量变化处理>副本数量变化处理</h5>
<blockquote>
<p>由于服务副本数量变化是通过k8s client监听的，通过通道传递。这里先解析在副本数量变动后如何处理，如何向上文中的通道发送数据。</p>
</blockquote>
<p>在监听到revision对应的endpoint资源信息有变动的时候，会将信息进行一定处理以后发送到updateCh。在启动activator的时候会调用此<code>Throttler</code>的run方法来处理状态变化。这里在监听的变化的时候直接交给了<code>handleUpdate</code>函数来处理。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Throttler</span>) <span style=color:#a6e22e>run</span>(<span style=color:#a6e22e>updateCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>revisionDestsUpdate</span>) {
   <span style=color:#66d9ef>for</span> {
      <span style=color:#66d9ef>select</span> {
      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>update</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>updateCh</span>:
         <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
            <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;The Throttler has stopped.&#34;</span>)
            <span style=color:#66d9ef>return</span>
         }
         <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>handleUpdate</span>(<span style=color:#a6e22e>update</span>)
      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>eps</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>epsUpdateCh</span>:
         <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>handlePubEpsUpdate</span>(<span style=color:#a6e22e>eps</span>)
      }
   }
}
</code></pre></div><p>Throttler的handleUpdate主要就是创建或者获取revisioin对应的<code>revisionThrottler</code>然后转到<code>pkg/activator/net/throttler.go</code>中的<code>revisionThrottler</code>来处理副本数和</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionThrottler</span>) <span style=color:#a6e22e>handleUpdate</span>(<span style=color:#a6e22e>update</span> <span style=color:#a6e22e>revisionDestsUpdate</span>) {
   <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugw</span>(<span style=color:#e6db74>&#34;Handling update&#34;</span>,
      <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;ClusterIP&#34;</span>, <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>ClusterIPDest</span>), <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Object</span>(<span style=color:#e6db74>&#34;dests&#34;</span>, <span style=color:#a6e22e>logging</span>.<span style=color:#a6e22e>StringSet</span>(<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>Dests</span>)))

   <span style=color:#75715e>// ClusterIP is not yet ready, so we want to send requests directly to the pods.
</span><span style=color:#75715e></span>   <span style=color:#75715e>// NB: this will not be called in parallel, thus we can build a new podTrackers
</span><span style=color:#75715e></span>   <span style=color:#75715e>// array before taking out a lock.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>ClusterIPDest</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
      <span style=color:#75715e>// Create a map for fast lookup of existing trackers.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>trackersMap</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>podTracker</span>, len(<span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span>))
      <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tracker</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span> {
         <span style=color:#a6e22e>trackersMap</span>[<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>dest</span>] = <span style=color:#a6e22e>tracker</span>
      }

      <span style=color:#a6e22e>trackers</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>podTracker</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>Dests</span>))

      <span style=color:#75715e>// Loop over dests, reuse existing tracker if we have one, otherwise create
</span><span style=color:#75715e></span>      <span style=color:#75715e>// a new one.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>newDest</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>Dests</span> {
         <span style=color:#a6e22e>tracker</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>trackersMap</span>[<span style=color:#a6e22e>newDest</span>]
         <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>containerConcurrency</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
               <span style=color:#a6e22e>tracker</span> = <span style=color:#a6e22e>newPodTracker</span>(<span style=color:#a6e22e>newDest</span>, <span style=color:#66d9ef>nil</span>)
            } <span style=color:#66d9ef>else</span> {
               <span style=color:#a6e22e>tracker</span> = <span style=color:#a6e22e>newPodTracker</span>(<span style=color:#a6e22e>newDest</span>, <span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>NewBreaker</span>(<span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>BreakerParams</span>{
                  <span style=color:#a6e22e>QueueDepth</span>:      <span style=color:#a6e22e>breakerQueueDepth</span>,
                  <span style=color:#a6e22e>MaxConcurrency</span>:  <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>containerConcurrency</span>,
                  <span style=color:#a6e22e>InitialCapacity</span>: <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>containerConcurrency</span>, <span style=color:#75715e>// Presume full unused capacity.
</span><span style=color:#75715e></span>               }))
            }
         }
         <span style=color:#a6e22e>trackers</span> = append(<span style=color:#a6e22e>trackers</span>, <span style=color:#a6e22e>tracker</span>)
      }

      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>updateThrottlerState</span>(len(<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>Dests</span>), <span style=color:#a6e22e>trackers</span>, <span style=color:#66d9ef>nil</span> <span style=color:#75715e>/*clusterIP*/</span>)
      <span style=color:#66d9ef>return</span>
   }

   <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>updateThrottlerState</span>(len(<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>Dests</span>), <span style=color:#66d9ef>nil</span> <span style=color:#75715e>/*trackers*/</span>, <span style=color:#a6e22e>newPodTracker</span>(<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>ClusterIPDest</span>, <span style=color:#66d9ef>nil</span>))
}
</code></pre></div><p>updateThrottlerState函数就是计算实际pod数量，然后调用<code>rt.updateCapacity</code>来更新pod数量。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionThrottler</span>) <span style=color:#a6e22e>updateThrottlerState</span>(<span style=color:#a6e22e>backendCount</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>trackers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>podTracker</span>, <span style=color:#a6e22e>clusterIPDest</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>podTracker</span>) {
   <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Updating Revision Throttler with: clusterIP = %v, trackers = %d, backends = %d&#34;</span>,
      <span style=color:#a6e22e>clusterIPDest</span>, len(<span style=color:#a6e22e>trackers</span>), <span style=color:#a6e22e>backendCount</span>)

   <span style=color:#75715e>// Update trackers / clusterIP before capacity. Otherwise we can race updating our breaker when
</span><span style=color:#75715e></span>   <span style=color:#75715e>// we increase capacity, causing a request to fall through before a tracker is added, causing an
</span><span style=color:#75715e></span>   <span style=color:#75715e>// incorrect LB decision.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>bool</span> {
      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Lock</span>()
      <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Unlock</span>()
      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span> = <span style=color:#a6e22e>trackers</span>
      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>clusterIPTracker</span> = <span style=color:#a6e22e>clusterIPDest</span>
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>clusterIPDest</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>trackers</span>) &gt; <span style=color:#ae81ff>0</span>
   }() {
      <span style=color:#75715e>// If we have an address to target, then pass through an accurate
</span><span style=color:#75715e></span>      <span style=color:#75715e>// accounting of the number of backends.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>updateCapacity</span>(<span style=color:#a6e22e>backendCount</span>)
   } <span style=color:#66d9ef>else</span> {
      <span style=color:#75715e>// If we do not have an address to target, then we should treat it
</span><span style=color:#75715e></span>      <span style=color:#75715e>// as though we have zero backends.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>updateCapacity</span>(<span style=color:#ae81ff>0</span>)
   }
}
</code></pre></div><p>updateCapacity最终根据pod数量计算出可以放行的最大请求数（即pod数量 * 每个pod允许并发数 / activator数量），然后调用<code>Breaker</code>的<code>UpdateConcurrency</code>函数（还记得这个breaker吗，这就是上文中hold住流量等待信号量的breaker），它调用了自己的信号量的<code>UpdateConcurrency</code>来最终通知到那些在阻塞等待的请求。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// updateCapacity updates the capacity of the throttler and recomputes
</span><span style=color:#75715e>// the assigned trackers to the Activator instance.
</span><span style=color:#75715e>// Currently updateCapacity is ensured to be invoked from a single go routine
</span><span style=color:#75715e>// and this does not synchronize
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionThrottler</span>) <span style=color:#a6e22e>updateCapacity</span>(<span style=color:#a6e22e>backendCount</span> <span style=color:#66d9ef>int</span>) {
   <span style=color:#75715e>// We have to make assignments on each updateCapacity, since if number
</span><span style=color:#75715e></span>   <span style=color:#75715e>// of activators changes, then we need to rebalance the assignedTrackers.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>ac</span>, <span style=color:#a6e22e>ai</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>numActivators</span>.<span style=color:#a6e22e>Load</span>()), int(<span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>activatorIndex</span>.<span style=color:#a6e22e>Load</span>())
   <span style=color:#a6e22e>numTrackers</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>int</span> {
      <span style=color:#75715e>// We do not have to process the `podTrackers` under lock, since
</span><span style=color:#75715e></span>      <span style=color:#75715e>// updateCapacity is guaranteed to be executed by a single goroutine.
</span><span style=color:#75715e></span>      <span style=color:#75715e>// But `assignedTrackers` is being read by the serving thread, so the
</span><span style=color:#75715e></span>      <span style=color:#75715e>// actual assignment has to be done under lock.
</span><span style=color:#75715e></span>
      <span style=color:#75715e>// We&#39;re using cluster IP.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>clusterIPTracker</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
         <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
      }

      <span style=color:#75715e>// Sort, so we get more or less stable results.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Slice</span>(<span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>dest</span> &lt; <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span>[<span style=color:#a6e22e>j</span>].<span style=color:#a6e22e>dest</span>
      })
      <span style=color:#a6e22e>assigned</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span>
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>containerConcurrency</span> &gt; <span style=color:#ae81ff>0</span> {
         <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>resetTrackers</span>()
         <span style=color:#a6e22e>assigned</span> = <span style=color:#a6e22e>assignSlice</span>(<span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span>, <span style=color:#a6e22e>ai</span>, <span style=color:#a6e22e>ac</span>, <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>containerConcurrency</span>)
      }
      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Trackers %d/%d: assignment: %v&#34;</span>, <span style=color:#a6e22e>ai</span>, <span style=color:#a6e22e>ac</span>, <span style=color:#a6e22e>assigned</span>)
      <span style=color:#75715e>// The actual write out of the assigned trackers has to be under lock.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Lock</span>()
      <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Unlock</span>()
      <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>assignedTrackers</span> = <span style=color:#a6e22e>assigned</span>
      <span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>assigned</span>)
   }()

   <span style=color:#a6e22e>capacity</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>numTrackers</span> &gt; <span style=color:#ae81ff>0</span> {
      <span style=color:#75715e>// Capacity is computed based off of number of trackers,
</span><span style=color:#75715e></span>      <span style=color:#75715e>// when using pod direct routing.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>capacity</span> = <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>calculateCapacity</span>(len(<span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>podTrackers</span>), <span style=color:#a6e22e>ac</span>)
   } <span style=color:#66d9ef>else</span> {
      <span style=color:#75715e>// Capacity is computed off of number of ready backends,
</span><span style=color:#75715e></span>      <span style=color:#75715e>// when we are using clusterIP routing.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>capacity</span> = <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>calculateCapacity</span>(<span style=color:#a6e22e>backendCount</span>, <span style=color:#a6e22e>ac</span>)
   }
   <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Set capacity to %d (backends: %d, index: %d/%d)&#34;</span>,
      <span style=color:#a6e22e>capacity</span>, <span style=color:#a6e22e>backendCount</span>, <span style=color:#a6e22e>ai</span>, <span style=color:#a6e22e>ac</span>)

   <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>backendCount</span> = <span style=color:#a6e22e>backendCount</span>
   <span style=color:#a6e22e>rt</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>UpdateConcurrency</span>(<span style=color:#a6e22e>capacity</span>)
}

<span style=color:#75715e>// UpdateConcurrency updates the maximum number of in-flight requests.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Breaker</span>) <span style=color:#a6e22e>UpdateConcurrency</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>updateCapacity</span>(<span style=color:#a6e22e>size</span>)
}
</code></pre></div><p>可以看到这里就是向<code>s.queue</code>发送了指定数量的数据，以放行这些流量。（// todo 这个时候pod扩缩容了会是什么情况）</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// updateCapacity updates the capacity of the semaphore to the desired size.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>semaphore</span>) <span style=color:#a6e22e>updateCapacity</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>s64</span> <span style=color:#f92672>:=</span> uint64(<span style=color:#a6e22e>size</span>)
	<span style=color:#66d9ef>for</span> {
		<span style=color:#a6e22e>old</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Load</span>()
		<span style=color:#a6e22e>capacity</span>, <span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unpack</span>(<span style=color:#a6e22e>old</span>)

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>capacity</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>s64</span> {
			<span style=color:#75715e>// Nothing to do, exit early.
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span>
		}

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>CAS</span>(<span style=color:#a6e22e>old</span>, <span style=color:#a6e22e>pack</span>(<span style=color:#a6e22e>s64</span>, <span style=color:#a6e22e>in</span>)) {
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s64</span> &gt; <span style=color:#a6e22e>capacity</span> {
				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> uint64(<span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>s64</span><span style=color:#f92672>-</span><span style=color:#a6e22e>capacity</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
					<span style=color:#66d9ef>select</span> {
					<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>queue</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}:
					<span style=color:#66d9ef>default</span>:
						<span style=color:#75715e>// See comment in `release` for explanation of this case.
</span><span style=color:#75715e></span>					}
				}
			}
			<span style=color:#66d9ef>return</span>
		}
	}
}
</code></pre></div><h5 id=监听副本数量变化>监听副本数量变化</h5>
<p>˙重点监听revision状态变化逻辑在<code>pkg/activator/net/revision_backends.go</code>定义。在去掉一些其他逻辑后，从下面可以看出在<code>newRevisionBackendsManagerWithProbeFrequency</code>函数中定义了对private service对应的endpoint的监听。<code>Throttler</code>的Run函数将监听到的变化和上文中副本数量变化的处理部分衔接起来。update channle中发送的是revision信息（name和namespace）。</p>
<p>前面说过对于revision和其endpoint的监听是在<code>pkg/activator/net/revision_backends.go</code>文件中定义的。会监听revision和endpoint资源。在revision有变动的时候，todo。主要是要监听endpoint资源的变动，在增加和删除的时候会调用update函数，传入当前的endpoint信息：</p>
<p>监听变动，筛选条件为带有revisionUID标签，并且必须是private的</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Run starts the throttler and blocks until the context is done.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Throttler</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>probeTransport</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>RoundTripper</span>, <span style=color:#a6e22e>usePassthroughLb</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>meshMode</span> <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>MeshCompatibilityMode</span>) {
	<span style=color:#a6e22e>rbm</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newRevisionBackendsManager</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>probeTransport</span>, <span style=color:#a6e22e>usePassthroughLb</span>, <span style=color:#a6e22e>meshMode</span>)
	<span style=color:#75715e>// Update channel is closed when ctx is done.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>run</span>(<span style=color:#a6e22e>rbm</span>.<span style=color:#a6e22e>updates</span>())
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newRevisionBackendsManager</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>tr</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>RoundTripper</span>, <span style=color:#a6e22e>usePassthroughLb</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>meshMode</span> <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>MeshCompatibilityMode</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionBackendsManager</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newRevisionBackendsManagerWithProbeFrequency</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>tr</span>, <span style=color:#a6e22e>usePassthroughLb</span>, <span style=color:#a6e22e>meshMode</span>, <span style=color:#a6e22e>defaultProbeFrequency</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newRevisionBackendsManagerWithProbeFrequency</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>tr</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>RoundTripper</span>,
   <span style=color:#a6e22e>usePassthroughLb</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>meshMode</span> <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>MeshCompatibilityMode</span>, <span style=color:#a6e22e>probeFreq</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionBackendsManager</span> {
   <span style=color:#a6e22e>rbm</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>revisionBackendsManager</span>{
      <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>   }
   <span style=color:#a6e22e>endpointsInformer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>endpointsinformer</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>)
   <span style=color:#a6e22e>endpointsInformer</span>.<span style=color:#a6e22e>Informer</span>().<span style=color:#a6e22e>AddEventHandler</span>(<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>FilteringResourceEventHandler</span>{
      <span style=color:#a6e22e>FilterFunc</span>: <span style=color:#a6e22e>reconciler</span>.<span style=color:#a6e22e>ChainFilterFuncs</span>(
         <span style=color:#a6e22e>reconciler</span>.<span style=color:#a6e22e>LabelExistsFilterFunc</span>(<span style=color:#a6e22e>serving</span>.<span style=color:#a6e22e>RevisionUID</span>),
         <span style=color:#75715e>// We are only interested in the private services, since that is
</span><span style=color:#75715e></span>         <span style=color:#75715e>// what is populated by the actual revision backends.
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>reconciler</span>.<span style=color:#a6e22e>LabelFilterFunc</span>(<span style=color:#a6e22e>networking</span>.<span style=color:#a6e22e>ServiceTypeKey</span>, string(<span style=color:#a6e22e>networking</span>.<span style=color:#a6e22e>ServiceTypePrivate</span>), <span style=color:#66d9ef>false</span>),
      ),
      <span style=color:#a6e22e>Handler</span>: <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>ResourceEventHandlerFuncs</span>{
         <span style=color:#a6e22e>AddFunc</span>:    <span style=color:#a6e22e>rbm</span>.<span style=color:#a6e22e>endpointsUpdated</span>,
         <span style=color:#a6e22e>UpdateFunc</span>: <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>PassNew</span>(<span style=color:#a6e22e>rbm</span>.<span style=color:#a6e22e>endpointsUpdated</span>),
         <span style=color:#a6e22e>DeleteFunc</span>: <span style=color:#a6e22e>rbm</span>.<span style=color:#a6e22e>endpointsDeleted</span>,
      },
   })
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rbm</span>
}
</code></pre></div><p>在监听到endpoint被添加和修改后的实际处理函数逻辑为：获取<code>RevisionWatcher</code>将ready的和notReady的pod信息发送到其<code>destsCh</code>中：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// endpointsUpdated is a handler function to be used by the Endpoints informer.
</span><span style=color:#75715e>// It updates the endpoints in the RevisionBackendsManager if the hosts changed
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rbm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionBackendsManager</span>) <span style=color:#a6e22e>endpointsUpdated</span>(<span style=color:#a6e22e>newObj</span> <span style=color:#66d9ef>interface</span>{}) {
   <span style=color:#75715e>// Ignore the updates when we&#39;ve terminated.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>select</span> {
   <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>rbm</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
      <span style=color:#66d9ef>return</span>
   <span style=color:#66d9ef>default</span>:
   }
   <span style=color:#a6e22e>endpoints</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newObj</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>corev1</span>.<span style=color:#a6e22e>Endpoints</span>)
   <span style=color:#a6e22e>revID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NamespacedName</span>{<span style=color:#a6e22e>Namespace</span>: <span style=color:#a6e22e>endpoints</span>.<span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>endpoints</span>.<span style=color:#a6e22e>Labels</span>[<span style=color:#a6e22e>serving</span>.<span style=color:#a6e22e>RevisionLabelKey</span>]}

   <span style=color:#a6e22e>rw</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rbm</span>.<span style=color:#a6e22e>getOrCreateRevisionWatcher</span>(<span style=color:#a6e22e>revID</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>rbm</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;Failed to get revision watcher&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>), <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>logkey</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>revID</span>.<span style=color:#a6e22e>String</span>()))
      <span style=color:#66d9ef>return</span>
   }
   <span style=color:#a6e22e>ready</span>, <span style=color:#a6e22e>notReady</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>endpointsToDests</span>(<span style=color:#a6e22e>endpoints</span>, <span style=color:#a6e22e>pkgnet</span>.<span style=color:#a6e22e>ServicePortName</span>(<span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>protocol</span>))
   <span style=color:#66d9ef>select</span> {
   <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>rbm</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
      <span style=color:#66d9ef>return</span>
   <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>destsCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>dests</span>{<span style=color:#a6e22e>ready</span>: <span style=color:#a6e22e>ready</span>, <span style=color:#a6e22e>notReady</span>: <span style=color:#a6e22e>notReady</span>}:
   }
}
</code></pre></div><p>revision watcher在被创建的时候会起协程运行run函数，每当通道内有消息的时候会将信息进行处理并交由<code>checkDests</code>进一步处理，最终在这个函数中交由<code>sendUpdate</code>将更新信息发到update channel中，这个channel就是一开始提到的。</p>
<p>删除部分辅助逻辑后，可以清晰看到此函数功能就是当<code>destsCh</code>新的dest到来的时候，就将之前的和现在的一起交由<code>sendUpdate</code>处理。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionWatcher</span>) <span style=color:#a6e22e>run</span>(<span style=color:#a6e22e>probeFrequency</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) {
	<span style=color:#66d9ef>defer</span> close(<span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>done</span>)

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>curDests</span>, <span style=color:#a6e22e>prevDests</span> <span style=color:#a6e22e>dests</span>
	<span style=color:#66d9ef>for</span> {

		<span style=color:#66d9ef>select</span> {
		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>stopCh</span>:
			<span style=color:#66d9ef>return</span>
		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>destsCh</span>:
			<span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Updating Endpoints: ready backends: %d, not-ready backends: %d&#34;</span>, len(<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>ready</span>), len(<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>notReady</span>))
			<span style=color:#a6e22e>prevDests</span>, <span style=color:#a6e22e>curDests</span> = <span style=color:#a6e22e>curDests</span>, <span style=color:#a6e22e>x</span>
		}

		<span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>checkDests</span>(<span style=color:#a6e22e>curDests</span>, <span style=color:#a6e22e>prevDests</span>)
	}
}
</code></pre></div><p>checkDests函数首先查看是否是缩容到0，如果是就直接发送pod已经缩容到0的通知逻辑。这一块逻辑稍微有点复杂，但是目标很简单，就是将现在这个服务的clusterIP和pod访问地址交由<code>sendUpdate</code>进一步处理。而<code>sendUpdate</code>就是将数据封装一下加上revision信息发送到update 通道。从而触发了上面副本变化的处理逻辑。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// checkDests performs probing and potentially sends a dests update. It is
</span><span style=color:#75715e>// assumed this method is not called concurrently.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionWatcher</span>) <span style=color:#a6e22e>checkDests</span>(<span style=color:#a6e22e>curDests</span>, <span style=color:#a6e22e>prevDests</span> <span style=color:#a6e22e>dests</span>) {
   <span style=color:#75715e>// 缩容到0后的处理
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>ready</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>notReady</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
      <span style=color:#75715e>// We must have scaled down.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>clusterIPHealthy</span> = <span style=color:#66d9ef>false</span>
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>healthyPods</span> = <span style=color:#66d9ef>nil</span>
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;ClusterIP is no longer healthy.&#34;</span>)
      <span style=color:#75715e>// Send update that we are now inactive (both params invalid).
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>sendUpdate</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>nil</span>)
      <span style=color:#66d9ef>return</span>
   }

   <span style=color:#75715e>// If we have discovered (or have been told via meshMode) that this revision
</span><span style=color:#75715e></span>   <span style=color:#75715e>// cannot be probed directly do not spend time trying.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>podsAddressable</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>meshMode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>MeshCompatibilityModeEnabled</span> {
      <span style=color:#75715e>// reprobe set contains the targets that moved from ready to non-ready set.
</span><span style=color:#75715e></span>      <span style=color:#75715e>// so they have to be re-probed.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>reprobe</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>becameNonReady</span>(<span style=color:#a6e22e>prevDests</span>)
      <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>reprobe</span>) &gt; <span style=color:#ae81ff>0</span> {
         <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infow</span>(<span style=color:#e6db74>&#34;Need to reprobe pods who became non-ready&#34;</span>,
            <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Object</span>(<span style=color:#e6db74>&#34;IPs&#34;</span>, <span style=color:#a6e22e>logging</span>.<span style=color:#a6e22e>StringSet</span>(<span style=color:#a6e22e>reprobe</span>)))
         <span style=color:#75715e>// Trim the pods that migrated to the non-ready set from the
</span><span style=color:#75715e></span>         <span style=color:#75715e>// ready set from the healthy pods. They will automatically
</span><span style=color:#75715e></span>         <span style=color:#75715e>// probed below.
</span><span style=color:#75715e></span>         <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>reprobe</span> {
            <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>healthyPods</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>p</span>)
         }
      }
      <span style=color:#75715e>// First check the pod IPs. If we can individually address
</span><span style=color:#75715e></span>      <span style=color:#75715e>// the Pods we should go that route, since it permits us to do
</span><span style=color:#75715e></span>      <span style=color:#75715e>// precise load balancing in the throttler.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>hs</span>, <span style=color:#a6e22e>noop</span>, <span style=color:#a6e22e>notMesh</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>probePodIPs</span>(<span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>ready</span>, <span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>notReady</span>)
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
         <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Warnw</span>(<span style=color:#e6db74>&#34;Failed probing pods&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Object</span>(<span style=color:#e6db74>&#34;curDests&#34;</span>, <span style=color:#a6e22e>curDests</span>), <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
         <span style=color:#75715e>// We dont want to return here as an error still affects health states.
</span><span style=color:#75715e></span>      }

      <span style=color:#75715e>// We need to send update if reprobe is non-empty, since the state
</span><span style=color:#75715e></span>      <span style=color:#75715e>// of the world has been changed.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Done probing, got %d healthy pods&#34;</span>, len(<span style=color:#a6e22e>hs</span>))
      <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>noop</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>reprobe</span>) &gt; <span style=color:#ae81ff>0</span> {
         <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>healthyPods</span> = <span style=color:#a6e22e>hs</span>
         <span style=color:#75715e>// Note: it&#39;s important that this copies (via hs.Union) the healthy pods
</span><span style=color:#75715e></span>         <span style=color:#75715e>// set before sending the update to avoid concurrent modifications
</span><span style=color:#75715e></span>         <span style=color:#75715e>// affecting the throttler, which iterates over the set.
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>sendUpdate</span>(<span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e>/*clusterIP*/</span>, <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>Union</span>(<span style=color:#66d9ef>nil</span>))
         <span style=color:#66d9ef>return</span>
      }
      <span style=color:#75715e>// no-op, and we have successfully probed at least one pod.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>hs</span>) &gt; <span style=color:#ae81ff>0</span> {
         <span style=color:#66d9ef>return</span>
      }
      <span style=color:#75715e>// We didn&#39;t get any pods, but we know the mesh is not enabled since we got
</span><span style=color:#75715e></span>      <span style=color:#75715e>// a non-mesh status code while probing, so we don&#39;t want to fall back.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>notMesh</span> {
         <span style=color:#66d9ef>return</span>
      }
   }

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>usePassthroughLb</span> {
      <span style=color:#75715e>// If passthrough lb is enabled we do not want to fall back to going via the
</span><span style=color:#75715e></span>      <span style=color:#75715e>// clusterIP and instead want to exit early.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span>
   }

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>meshMode</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>MeshCompatibilityModeDisabled</span> {
      <span style=color:#75715e>// If mesh is disabled we always want to use direct pod addressing, and
</span><span style=color:#75715e></span>      <span style=color:#75715e>// will not fall back to clusterIP.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span>
   }

   <span style=color:#75715e>// If we failed to probe even a single pod, check the clusterIP.
</span><span style=color:#75715e></span>   <span style=color:#75715e>// NB: We can&#39;t cache the IP address, since user might go rogue
</span><span style=color:#75715e></span>   <span style=color:#75715e>// and delete the K8s service. We&#39;ll fix it, but the cluster IP will be different.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>dest</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>getDest</span>()
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;Failed to determine service destination&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
      <span style=color:#66d9ef>return</span>
   }

   <span style=color:#75715e>// If cluster IP is healthy and we haven&#39;t scaled down, short circuit.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>clusterIPHealthy</span> {
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;ClusterIP %s already probed (ready backends: %d)&#34;</span>, <span style=color:#a6e22e>dest</span>, len(<span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>ready</span>))
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>sendUpdate</span>(<span style=color:#a6e22e>dest</span>, <span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>ready</span>)
      <span style=color:#66d9ef>return</span>
   }

   <span style=color:#75715e>// If clusterIP is healthy send this update and we are done.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>probeClusterIP</span>(<span style=color:#a6e22e>dest</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;Failed to probe clusterIP &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>dest</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
   } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
      <span style=color:#75715e>// We can reach here only iff pods are not successfully individually probed
</span><span style=color:#75715e></span>      <span style=color:#75715e>// but ClusterIP conversely has been successfully probed.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>podsAddressable</span> = <span style=color:#66d9ef>false</span>
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;ClusterIP is successfully probed: %s (ready backends: %d)&#34;</span>, <span style=color:#a6e22e>dest</span>, len(<span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>ready</span>))
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>clusterIPHealthy</span> = <span style=color:#66d9ef>true</span>
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>healthyPods</span> = <span style=color:#66d9ef>nil</span>
      <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>sendUpdate</span>(<span style=color:#a6e22e>dest</span>, <span style=color:#a6e22e>curDests</span>.<span style=color:#a6e22e>ready</span>)
   }
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>revisionWatcher</span>) <span style=color:#a6e22e>sendUpdate</span>(<span style=color:#a6e22e>clusterIP</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>dests</span> <span style=color:#a6e22e>sets</span>.<span style=color:#a6e22e>String</span>) {
	<span style=color:#66d9ef>select</span> {
	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>stopCh</span>:
		<span style=color:#66d9ef>return</span>
	<span style=color:#66d9ef>default</span>:
		<span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>updateCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>revisionDestsUpdate</span>{<span style=color:#a6e22e>Rev</span>: <span style=color:#a6e22e>rw</span>.<span style=color:#a6e22e>rev</span>, <span style=color:#a6e22e>ClusterIPDest</span>: <span style=color:#a6e22e>clusterIP</span>, <span style=color:#a6e22e>Dests</span>: <span style=color:#a6e22e>dests</span>}
	}
}
</code></pre></div><p>endpoint的修改是由k8s自动触发的。</p>
<h3 id=从0扩容autoscaler源码分析>从0扩容autoscaler源码分析</h3>
<h4 id=接收activator从0扩容指标>接收activator从0扩容指标</h4>
<p>首先让我们把目光聚焦到接收activator 发送的metrics并进行处理的逻辑。<code>statserver</code>启动一个websocket服务器，接收activator在服务没有副本的时候发送的流量参数，标志着这个服务需要立即从0扩容。这里通过<code>statsCh</code>将指标的接收与处理解耦开来。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
  <span style=color:#75715e>// ......
</span><span style=color:#75715e></span>
   <span style=color:#75715e>// autoscaler在接收到从websocket上报的指标后，会把消息内容发送到这个通道中进行异步处理。
</span><span style=color:#75715e></span>   <span style=color:#75715e>// statsCh is the main communication channel between the stats server and multiscaler.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>statsCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>StatMessage</span>, <span style=color:#a6e22e>statsBufferLen</span>)
   <span style=color:#66d9ef>defer</span> close(<span style=color:#a6e22e>statsCh</span>)
  
  <span style=color:#75715e>// ......
</span><span style=color:#75715e></span>  
  	<span style=color:#75715e>// accept is the func to call when this pod owns the Revision for this StatMessage.
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 实际有了请求之后，冷启动时发送过来的信息
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>accept</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>sm</span> <span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>StatMessage</span>) {
    <span style=color:#75715e>// 这个就是将指标发给统计的，在计算扩缩容状态的时候就会用到这些指标
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>collector</span>.<span style=color:#a6e22e>Record</span>(<span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Unix</span>(<span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Stat</span>.<span style=color:#a6e22e>Timestamp</span>, <span style=color:#ae81ff>0</span>), <span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Stat</span>)
		<span style=color:#a6e22e>multiScaler</span>.<span style=color:#a6e22e>Poke</span>(<span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Stat</span>)
	}

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>statforwarder</span>.<span style=color:#a6e22e>Forwarder</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>bs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>leaderelection</span>.<span style=color:#a6e22e>NewStatefulSetBucketAndSet</span>(int(<span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>Buckets</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Running with StatefulSet leader election&#34;</span>)
		<span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>leaderelection</span>.<span style=color:#a6e22e>WithStatefulSetElectorBuilder</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cc</span>, <span style=color:#a6e22e>b</span>)
		<span style=color:#a6e22e>f</span> = <span style=color:#a6e22e>statforwarder</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>bs</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>statforwarder</span>.<span style=color:#a6e22e>StatefulSetBasedProcessor</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>accept</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Fatalw</span>(<span style=color:#e6db74>&#34;Failed to set up statefulset processors&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
		}
	} <span style=color:#66d9ef>else</span> {
		<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Running with Standard leader election&#34;</span>)
		<span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>leaderelection</span>.<span style=color:#a6e22e>WithStandardLeaderElectorBuilder</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>kubeClient</span>, <span style=color:#a6e22e>cc</span>)
		<span style=color:#a6e22e>f</span> = <span style=color:#a6e22e>statforwarder</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>AutoscalerBucketSet</span>(<span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>Buckets</span>))
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>statforwarder</span>.<span style=color:#a6e22e>LeaseBasedProcessor</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>accept</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Fatalw</span>(<span style=color:#e6db74>&#34;Failed to set up lease tracking&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
		}
	}

   <span style=color:#75715e>// Set up a statserver.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>statsServer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>statserver</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>statsServerAddr</span>, <span style=color:#a6e22e>statsCh</span>, <span style=color:#a6e22e>logger</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>IsBucketOwner</span>)

   <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Cancel</span>()

   <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>StartAll</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>controllers</span><span style=color:#f92672>...</span>)

   <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
      <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>sm</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>statsCh</span> {
         <span style=color:#75715e>// Set the timestamp when first receiving the stat.
</span><span style=color:#75715e></span>         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Stat</span>.<span style=color:#a6e22e>Timestamp</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
            <span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Stat</span>.<span style=color:#a6e22e>Timestamp</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Unix</span>()
         }
         <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Process</span>(<span style=color:#a6e22e>sm</span>)
      }
   }()

   <span style=color:#a6e22e>profilingServer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>profiling</span>.<span style=color:#a6e22e>NewServer</span>(<span style=color:#a6e22e>profilingHandler</span>)

   <span style=color:#a6e22e>eg</span>, <span style=color:#a6e22e>egCtx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errgroup</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>ctx</span>)
   <span style=color:#a6e22e>eg</span>.<span style=color:#a6e22e>Go</span>(<span style=color:#a6e22e>statsServer</span>.<span style=color:#a6e22e>ListenAndServe</span>)
   <span style=color:#a6e22e>eg</span>.<span style=color:#a6e22e>Go</span>(<span style=color:#a6e22e>profilingServer</span>.<span style=color:#a6e22e>ListenAndServe</span>)
}
</code></pre></div><p>上面可以看到指标都是由Process函数进行处理的。这个函数是将消息发往一个内部通道，获取processor并在其<code>process</code>函数中进行处理并执行重试逻辑，最大重试次数是硬编码的30次，每次重试间隔500ms。注意一点是autoscaler处于主节点和从节点模式下processor的处理逻辑是不同的。如果是从节点的话，就把这个消息再发到主节点的websocket端口上去，然后主节点的逻辑又会走到这里，所以后面主要以当前autoscaler是主节点情况下分析。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Process enqueues the given Stat for processing asynchronously.
</span><span style=color:#75715e>// It calls Forwarder.accept if the pod where this Forwarder is running is the owner
</span><span style=color:#75715e>// of the given StatMessage. Otherwise it forwards the given StatMessage to the right
</span><span style=color:#75715e>// owner pod. It will retry if any error happens during the processing.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Forwarder</span>) <span style=color:#a6e22e>Process</span>(<span style=color:#a6e22e>sm</span> <span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>StatMessage</span>) {
   <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>statCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>stat</span>{<span style=color:#a6e22e>sm</span>: <span style=color:#a6e22e>sm</span>, <span style=color:#a6e22e>retry</span>: <span style=color:#ae81ff>0</span>}
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Forwarder</span>) <span style=color:#a6e22e>process</span>() {
   <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
      <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>retryWg</span>.<span style=color:#a6e22e>Wait</span>()
      <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>processingWg</span>.<span style=color:#a6e22e>Done</span>()
   }()

   <span style=color:#66d9ef>for</span> {
      <span style=color:#66d9ef>select</span> {
      <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>stopCh</span>:
         <span style=color:#66d9ef>return</span>
      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>statCh</span>:
         <span style=color:#a6e22e>rev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Key</span>.<span style=color:#a6e22e>String</span>()
         <span style=color:#a6e22e>l</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>With</span>(<span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>logkey</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>rev</span>))
         <span style=color:#a6e22e>bkt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>bs</span>.<span style=color:#a6e22e>Owner</span>(<span style=color:#a6e22e>rev</span>)

         <span style=color:#75715e>// 获取processor,由于高可用情况下存在多个autoscaler副本，但是只有一个能处理。所以processor也有两种类型
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>getProcessor</span>(<span style=color:#a6e22e>bkt</span>)
         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;Can&#39;t find the owner for Revision bucket: &#34;</span>, <span style=color:#a6e22e>bkt</span>)
            <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>maybeRetry</span>(<span style=color:#a6e22e>l</span>, <span style=color:#a6e22e>s</span>)
            <span style=color:#66d9ef>continue</span>
         }

         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>process</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sm</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;Error while processing stat&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
            <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>maybeRetry</span>(<span style=color:#a6e22e>l</span>, <span style=color:#a6e22e>s</span>)
         }
      }
   }
}
</code></pre></div><p>这里看下process的处理，就是调用了之前main函数中定义的accept，做了两件事情一个是记录指标，指标记录是一个单独的逻辑会在后面介绍。一个是调用<code>multiScaler.Poke</code>这个方法，接下来看下这个方法做了什么。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>localProcessor</span>) <span style=color:#a6e22e>process</span>(<span style=color:#a6e22e>sm</span> <span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>StatMessage</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>l</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>With</span>(<span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>logkey</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Key</span>.<span style=color:#a6e22e>String</span>()))
	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;Accept stat as owner of bucket &#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>bkt</span>)
	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>accept</span>(<span style=color:#a6e22e>sm</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}

<span style=color:#75715e>// accept 对应在main函数中定义的函数，传递进来的
</span><span style=color:#75715e></span><span style=color:#a6e22e>accept</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>sm</span> <span style=color:#a6e22e>asmetrics</span>.<span style=color:#a6e22e>StatMessage</span>) {
    <span style=color:#75715e>// 这个就是将指标发给统计的，在计算扩缩容状态的时候就会用到这些指标
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>collector</span>.<span style=color:#a6e22e>Record</span>(<span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Unix</span>(<span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Stat</span>.<span style=color:#a6e22e>Timestamp</span>, <span style=color:#ae81ff>0</span>), <span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Stat</span>)
		<span style=color:#a6e22e>multiScaler</span>.<span style=color:#a6e22e>Poke</span>(<span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>sm</span>.<span style=color:#a6e22e>Stat</span>)
}
</code></pre></div><p>这个函数的作用就是检查是否立即触发扩容。如果目前副本数是0，但是并发数不为0，就要立即从0扩容，就将信号发送到revision对应的scaler的<code>pokeCh</code>通道中。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// 这个函数的作用就是检查是否立即触发扩容
</span><span style=color:#75715e>// Poke checks if the autoscaler needs to be run immediately.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiScaler</span>) <span style=color:#a6e22e>Poke</span>(<span style=color:#a6e22e>key</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NamespacedName</span>, <span style=color:#a6e22e>stat</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>Stat</span>) {
   <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>scalersMutex</span>.<span style=color:#a6e22e>RLock</span>()
   <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>scalersMutex</span>.<span style=color:#a6e22e>RUnlock</span>()

   <span style=color:#a6e22e>scaler</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>scalers</span>[<span style=color:#a6e22e>key</span>]
   <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
      <span style=color:#66d9ef>return</span>
   }

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>scaler</span>.<span style=color:#a6e22e>latestScale</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>stat</span>.<span style=color:#a6e22e>AverageConcurrentRequests</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
      <span style=color:#a6e22e>scaler</span>.<span style=color:#a6e22e>pokeCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}
   }
}
</code></pre></div><h4 id=触发扩缩容>触发扩缩容</h4>
<p>对<code>pokeCh</code>处理的核心逻辑定义在<code>pkg/autoscaler/scaling/multiscaler.go</code>文件中，可以看到计算扩缩容的操作会被周期触发，或者在<code>pokeCh</code>有数据时立即触发。扩缩容处理函数<code>tickScaler</code>就是获取</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiScaler</span>) <span style=color:#a6e22e>runScalerTicker</span>(<span style=color:#a6e22e>runner</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>scalerRunner</span>, <span style=color:#a6e22e>metricKey</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NamespacedName</span>) {
   <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>tickProvider</span>(<span style=color:#a6e22e>tickInterval</span>)
   <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
      <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
      <span style=color:#66d9ef>for</span> {
         <span style=color:#66d9ef>select</span> {
         <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>scalersStopCh</span>:
            <span style=color:#66d9ef>return</span>
         <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>stopCh</span>:
            <span style=color:#66d9ef>return</span>
         <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span>:
            <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>tickScaler</span>(<span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>scaler</span>, <span style=color:#a6e22e>runner</span>, <span style=color:#a6e22e>metricKey</span>)
         <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>pokeCh</span>:
            <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>tickScaler</span>(<span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>scaler</span>, <span style=color:#a6e22e>runner</span>, <span style=color:#a6e22e>metricKey</span>)
         }
      }
   }()
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiScaler</span>) <span style=color:#a6e22e>tickScaler</span>(<span style=color:#a6e22e>scaler</span> <span style=color:#a6e22e>UniScaler</span>, <span style=color:#a6e22e>runner</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>scalerRunner</span>, <span style=color:#a6e22e>metricKey</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NamespacedName</span>) {
  <span style=color:#75715e>// scaler.Scale是一个比较复杂的函数，其主要作用就是计算期望副本数。其返回值结构体如下：
</span><span style=color:#75715e></span>  <span style=color:#75715e>//type ScaleResult struct {
</span><span style=color:#75715e></span>	<span style=color:#75715e>//  期望副本数.
</span><span style=color:#75715e></span>	<span style=color:#75715e>//	DesiredPodCount int32
</span><span style=color:#75715e></span>	<span style=color:#75715e>//  是考虑到目标突发容量的修正后的满负荷容量.
</span><span style=color:#75715e></span>	<span style=color:#75715e>//	ExcessBurstCapacity int32
</span><span style=color:#75715e></span>	<span style=color:#75715e>//  这个结果是否有用
</span><span style=color:#75715e></span>	<span style=color:#75715e>//	ScaleValid bool
</span><span style=color:#75715e></span>  <span style=color:#75715e>//}
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>sr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scaler</span>.<span style=color:#a6e22e>Scale</span>(<span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>logger</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>())

	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>ScaleValid</span> {
		<span style=color:#66d9ef>return</span>
	}

  <span style=color:#75715e>// scalerRunner也是一个非常核心的struct，这里主要就是将计算结构更新到自己的结构体内部字段。特别是期望副本数，在其他地方想要取期望副本数的时候，就通过此结构体取。
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>updateLatestScale</span>(<span style=color:#a6e22e>sr</span>) {
		<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Inform</span>(<span style=color:#a6e22e>metricKey</span>)
	}
}
</code></pre></div><p>Scale的定义在<code>pkg/autoscaler/scaling/autoscaler.go</code>文件中。如果你觉得太长你就大概理解为这个函数根据activator和queue上报上来的指标计算期望副本数就行了。具体在下面函数中关键点都有注释</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Scale calculates the desired scale based on current statistics given the current time.
</span><span style=color:#75715e>// desiredPodCount is the calculated pod count the autoscaler would like to set.
</span><span style=color:#75715e>// validScale signifies whether the desiredPodCount should be applied or not.
</span><span style=color:#75715e>// Scale is not thread safe in regards to panic state, but it&#39;s thread safe in
</span><span style=color:#75715e>// regards to acquiring the decider spec.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>autoscaler</span>) <span style=color:#a6e22e>Scale</span>(<span style=color:#a6e22e>logger</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>SugaredLogger</span>, <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>) <span style=color:#a6e22e>ScaleResult</span> {
   <span style=color:#a6e22e>desugared</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Desugar</span>()
   <span style=color:#a6e22e>debugEnabled</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>desugared</span>.<span style=color:#a6e22e>Core</span>().<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>zapcore</span>.<span style=color:#a6e22e>DebugLevel</span>)

   <span style=color:#75715e>// 获取缩放配置
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>spec</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>currentSpec</span>()
   <span style=color:#75715e>// 获取ready的pod的数量
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>originalReadyPodsCount</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>podCounter</span>.<span style=color:#a6e22e>ReadyCount</span>()
   <span style=color:#75715e>// If the error is NotFound, then presume 0.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>apierrors</span>.<span style=color:#a6e22e>IsNotFound</span>(<span style=color:#a6e22e>err</span>) {
      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;Failed to get ready pod count via K8S Lister&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>invalidSR</span>
   }
   <span style=color:#75715e>// Use 1 if there are zero current pods.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>readyPodsCount</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Max</span>(<span style=color:#ae81ff>1</span>, float64(<span style=color:#a6e22e>originalReadyPodsCount</span>))

   <span style=color:#a6e22e>metricKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NamespacedName</span>{<span style=color:#a6e22e>Namespace</span>: <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>namespace</span>, <span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>revision</span>}

   <span style=color:#a6e22e>metricName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>ScalingMetric</span>
   <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>observedStableValue</span>, <span style=color:#a6e22e>observedPanicValue</span> <span style=color:#66d9ef>float64</span>
   <span style=color:#75715e>// 对应两种扩容模式：并发数RPS、每秒请求数concurrency
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>ScalingMetric</span> {
   <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>autoscaling</span>.<span style=color:#a6e22e>RPS</span>:
      <span style=color:#a6e22e>observedStableValue</span>, <span style=color:#a6e22e>observedPanicValue</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>metricClient</span>.<span style=color:#a6e22e>StableAndPanicRPS</span>(<span style=color:#a6e22e>metricKey</span>, <span style=color:#a6e22e>now</span>)
   <span style=color:#66d9ef>default</span>:
      <span style=color:#a6e22e>metricName</span> = <span style=color:#a6e22e>autoscaling</span>.<span style=color:#a6e22e>Concurrency</span> <span style=color:#75715e>// concurrency is used by default
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>observedStableValue</span>, <span style=color:#a6e22e>observedPanicValue</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>metricClient</span>.<span style=color:#a6e22e>StableAndPanicConcurrency</span>(<span style=color:#a6e22e>metricKey</span>, <span style=color:#a6e22e>now</span>)
   }

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ErrNoData</span>) {
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;No data to scale on yet&#34;</span>)
      } <span style=color:#66d9ef>else</span> {
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;Failed to obtain metrics&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
      }
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>invalidSR</span>
   }

   <span style=color:#75715e>// 根据获取的指标数据计算需要的pod数量
</span><span style=color:#75715e></span>   <span style=color:#75715e>// Make sure we don&#39;t get stuck with the same number of pods, if the scale up rate
</span><span style=color:#75715e></span>   <span style=color:#75715e>// is too conservative and MaxScaleUp*RPC==RPC, so this permits us to grow at least by a single
</span><span style=color:#75715e></span>   <span style=color:#75715e>// pod if we need to scale up.
</span><span style=color:#75715e></span>   <span style=color:#75715e>// E.g. MSUR=1.1, OCC=3, RPC=2, TV=1 =&gt; OCC/TV=3, MSU=2.2 =&gt; DSPC=2, while we definitely, need
</span><span style=color:#75715e></span>   <span style=color:#75715e>// 3 pods. See the unit test for this scenario in action.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>maxScaleUp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Ceil</span>(<span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>MaxScaleUpRate</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>readyPodsCount</span>)
   <span style=color:#75715e>// Same logic, opposite math applies here.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>maxScaleDown</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0.</span>
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>Reachable</span> {
      <span style=color:#a6e22e>maxScaleDown</span> = <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Floor</span>(<span style=color:#a6e22e>readyPodsCount</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>MaxScaleDownRate</span>)
   }

   <span style=color:#a6e22e>dspc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Ceil</span>(<span style=color:#a6e22e>observedStableValue</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetValue</span>)
   <span style=color:#a6e22e>dppc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Ceil</span>(<span style=color:#a6e22e>observedPanicValue</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetValue</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debugEnabled</span> {
      <span style=color:#a6e22e>desugared</span>.<span style=color:#a6e22e>Debug</span>(
         <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;For metric %s observed values: stable = %0.3f; panic = %0.3f; target = %0.3f &#34;</span><span style=color:#f92672>+</span>
            <span style=color:#e6db74>&#34;Desired StablePodCount = %0.0f, PanicPodCount = %0.0f, ReadyEndpointCount = %d, MaxScaleUp = %0.0f, MaxScaleDown = %0.0f&#34;</span>,
            <span style=color:#a6e22e>metricName</span>, <span style=color:#a6e22e>observedStableValue</span>, <span style=color:#a6e22e>observedPanicValue</span>, <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetValue</span>,
            <span style=color:#a6e22e>dspc</span>, <span style=color:#a6e22e>dppc</span>, <span style=color:#a6e22e>originalReadyPodsCount</span>, <span style=color:#a6e22e>maxScaleUp</span>, <span style=color:#a6e22e>maxScaleDown</span>))
   }

   <span style=color:#75715e>// We want to keep desired pod count in the  [maxScaleDown, maxScaleUp] range.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>desiredStablePodCount</span> <span style=color:#f92672>:=</span> int32(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Min</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Max</span>(<span style=color:#a6e22e>dspc</span>, <span style=color:#a6e22e>maxScaleDown</span>), <span style=color:#a6e22e>maxScaleUp</span>))
   <span style=color:#a6e22e>desiredPanicPodCount</span> <span style=color:#f92672>:=</span> int32(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Min</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Max</span>(<span style=color:#a6e22e>dppc</span>, <span style=color:#a6e22e>maxScaleDown</span>), <span style=color:#a6e22e>maxScaleUp</span>))

   <span style=color:#a6e22e>isOverPanicThreshold</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dppc</span><span style=color:#f92672>/</span><span style=color:#a6e22e>readyPodsCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>PanicThreshold</span>

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>panicTime</span>.<span style=color:#a6e22e>IsZero</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>isOverPanicThreshold</span> {
      <span style=color:#75715e>// Begin panicking when we cross the threshold in the panic window.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;PANICKING.&#34;</span>)
      <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>panicTime</span> = <span style=color:#a6e22e>now</span>
      <span style=color:#a6e22e>pkgmetrics</span>.<span style=color:#a6e22e>Record</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>reporterCtx</span>, <span style=color:#a6e22e>panicM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#ae81ff>1</span>))
   } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isOverPanicThreshold</span> {
      <span style=color:#75715e>// If we&#39;re still over panic threshold right now — extend the panic window.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>panicTime</span> = <span style=color:#a6e22e>now</span>
   } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>panicTime</span>.<span style=color:#a6e22e>IsZero</span>() <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>isOverPanicThreshold</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>panicTime</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>StableWindow</span>).<span style=color:#a6e22e>Before</span>(<span style=color:#a6e22e>now</span>) {
      <span style=color:#75715e>// Stop panicking after the surge has made its way into the stable metric.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Un-panicking.&#34;</span>)
      <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>panicTime</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>{}
      <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>maxPanicPods</span> = <span style=color:#ae81ff>0</span>
      <span style=color:#a6e22e>pkgmetrics</span>.<span style=color:#a6e22e>Record</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>reporterCtx</span>, <span style=color:#a6e22e>panicM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#ae81ff>0</span>))
   }

   <span style=color:#a6e22e>desiredPodCount</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>desiredStablePodCount</span>
   <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>panicTime</span>.<span style=color:#a6e22e>IsZero</span>() {
      <span style=color:#75715e>// In some edgecases stable window metric might be larger
</span><span style=color:#75715e></span>      <span style=color:#75715e>// than panic one. And we should provision for stable as for panic,
</span><span style=color:#75715e></span>      <span style=color:#75715e>// so pick the larger of the two.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>desiredPodCount</span> &lt; <span style=color:#a6e22e>desiredPanicPodCount</span> {
         <span style=color:#a6e22e>desiredPodCount</span> = <span style=color:#a6e22e>desiredPanicPodCount</span>
      }
      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;Operating in panic mode.&#34;</span>)
      <span style=color:#75715e>// We do not scale down while in panic mode. Only increases will be applied.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>desiredPodCount</span> &gt; <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>maxPanicPods</span> {
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Increasing pods count from %d to %d.&#34;</span>, <span style=color:#a6e22e>originalReadyPodsCount</span>, <span style=color:#a6e22e>desiredPodCount</span>)
         <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>maxPanicPods</span> = <span style=color:#a6e22e>desiredPodCount</span>
      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>desiredPodCount</span> &lt; <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>maxPanicPods</span> {
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Skipping pod count decrease from %d to %d.&#34;</span>, <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>maxPanicPods</span>, <span style=color:#a6e22e>desiredPodCount</span>)
      }
      <span style=color:#a6e22e>desiredPodCount</span> = <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>maxPanicPods</span>
   } <span style=color:#66d9ef>else</span> {
      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;Operating in stable mode.&#34;</span>)
   }

   <span style=color:#75715e>// Delay scale down decisions, if a ScaleDownDelay was specified.
</span><span style=color:#75715e></span>   <span style=color:#75715e>// We only do this if there&#39;s a non-nil delayWindow because although a
</span><span style=color:#75715e></span>   <span style=color:#75715e>// one-element delay window is _almost_ the same as no delay at all, it is
</span><span style=color:#75715e></span>   <span style=color:#75715e>// not the same in the case where two Scale()s happen in the same time
</span><span style=color:#75715e></span>   <span style=color:#75715e>// interval (because the largest will be picked rather than the most recent
</span><span style=color:#75715e></span>   <span style=color:#75715e>// in that case).
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>delayWindow</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>delayWindow</span>.<span style=color:#a6e22e>Record</span>(<span style=color:#a6e22e>now</span>, <span style=color:#a6e22e>desiredPodCount</span>)
      <span style=color:#a6e22e>delayedPodCount</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>delayWindow</span>.<span style=color:#a6e22e>Current</span>()
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>delayedPodCount</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>desiredPodCount</span> {
         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debugEnabled</span> {
            <span style=color:#a6e22e>desugared</span>.<span style=color:#a6e22e>Debug</span>(
               <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Delaying scale to %d, staying at %d&#34;</span>,
                  <span style=color:#a6e22e>desiredPodCount</span>, <span style=color:#a6e22e>delayedPodCount</span>))
         }
         <span style=color:#a6e22e>desiredPodCount</span> = <span style=color:#a6e22e>delayedPodCount</span>
      }
   }

   <span style=color:#75715e>// Compute excess burst capacity
</span><span style=color:#75715e></span>   <span style=color:#75715e>//
</span><span style=color:#75715e></span>   <span style=color:#75715e>// the excess burst capacity is based on panic value, since we don&#39;t want to
</span><span style=color:#75715e></span>   <span style=color:#75715e>// be making knee-jerk decisions about Activator in the request path.
</span><span style=color:#75715e></span>   <span style=color:#75715e>// Negative EBC means that the deployment does not have enough capacity to serve
</span><span style=color:#75715e></span>   <span style=color:#75715e>// the desired burst off hand.
</span><span style=color:#75715e></span>   <span style=color:#75715e>// EBC = TotCapacity - Cur#ReqInFlight - TargetBurstCapacity
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>excessBCF</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1.</span>
   <span style=color:#66d9ef>switch</span> {
   <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetBurstCapacity</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
      <span style=color:#a6e22e>excessBCF</span> = <span style=color:#ae81ff>0</span>
   <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetBurstCapacity</span> &gt; <span style=color:#ae81ff>0</span>:
      <span style=color:#a6e22e>totCap</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>originalReadyPodsCount</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TotalValue</span>
      <span style=color:#a6e22e>excessBCF</span> = <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Floor</span>(<span style=color:#a6e22e>totCap</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetBurstCapacity</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>observedPanicValue</span>)
   }

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debugEnabled</span> {
      <span style=color:#a6e22e>desugared</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;PodCount=%d Total1PodCapacity=%0.3f ObsStableValue=%0.3f ObsPanicValue=%0.3f TargetBC=%0.3f ExcessBC=%0.3f&#34;</span>,
         <span style=color:#a6e22e>originalReadyPodsCount</span>, <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TotalValue</span>, <span style=color:#a6e22e>observedStableValue</span>,
         <span style=color:#a6e22e>observedPanicValue</span>, <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetBurstCapacity</span>, <span style=color:#a6e22e>excessBCF</span>))
   }

   <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>ScalingMetric</span> {
   <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>autoscaling</span>.<span style=color:#a6e22e>RPS</span>:
      <span style=color:#a6e22e>pkgmetrics</span>.<span style=color:#a6e22e>RecordBatch</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>reporterCtx</span>,
         <span style=color:#a6e22e>excessBurstCapacityM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#a6e22e>excessBCF</span>),
         <span style=color:#a6e22e>desiredPodCountM</span>.<span style=color:#a6e22e>M</span>(int64(<span style=color:#a6e22e>desiredPodCount</span>)),
         <span style=color:#a6e22e>stableRPSM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#a6e22e>observedStableValue</span>),
         <span style=color:#a6e22e>panicRPSM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#a6e22e>observedStableValue</span>),
         <span style=color:#a6e22e>targetRPSM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetValue</span>),
      )
   <span style=color:#66d9ef>default</span>:
      <span style=color:#a6e22e>pkgmetrics</span>.<span style=color:#a6e22e>RecordBatch</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>reporterCtx</span>,
         <span style=color:#a6e22e>excessBurstCapacityM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#a6e22e>excessBCF</span>),
         <span style=color:#a6e22e>desiredPodCountM</span>.<span style=color:#a6e22e>M</span>(int64(<span style=color:#a6e22e>desiredPodCount</span>)),
         <span style=color:#a6e22e>stableRequestConcurrencyM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#a6e22e>observedStableValue</span>),
         <span style=color:#a6e22e>panicRequestConcurrencyM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#a6e22e>observedPanicValue</span>),
         <span style=color:#a6e22e>targetRequestConcurrencyM</span>.<span style=color:#a6e22e>M</span>(<span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>TargetValue</span>),
      )
   }

   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ScaleResult</span>{
      <span style=color:#a6e22e>DesiredPodCount</span>:     <span style=color:#a6e22e>desiredPodCount</span>,
      <span style=color:#a6e22e>ExcessBurstCapacity</span>: int32(<span style=color:#a6e22e>excessBCF</span>),
      <span style=color:#a6e22e>ScaleValid</span>:          <span style=color:#66d9ef>true</span>,
   }
}
</code></pre></div><p>我们简单看下在计算出缩放信息后<code>updateLatestScale</code>做的事情，这个函数的返回就是标志者是否要放到事件队列中触发下游的更新。这个函数的作用就是将副本信息放到<code>sr.decider.Status</code>中。<code>decider</code>看起来本来是一种k8s资源后来发现只需要存在内存中就可以了。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>scalerRunner</span>) <span style=color:#a6e22e>updateLatestScale</span>(<span style=color:#a6e22e>sRes</span> <span style=color:#a6e22e>ScaleResult</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#a6e22e>ret</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
	<span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Unlock</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>DesiredScale</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>sRes</span>.<span style=color:#a6e22e>DesiredPodCount</span> {
		<span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>DesiredScale</span> = <span style=color:#a6e22e>sRes</span>.<span style=color:#a6e22e>DesiredPodCount</span>
		<span style=color:#a6e22e>ret</span> = <span style=color:#66d9ef>true</span>
	}

	<span style=color:#75715e>// If sign has changed -- then we have to update KPA.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>ret</span> = <span style=color:#a6e22e>ret</span> <span style=color:#f92672>||</span> !<span style=color:#a6e22e>sameSign</span>(<span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ExcessBurstCapacity</span>, <span style=color:#a6e22e>sRes</span>.<span style=color:#a6e22e>ExcessBurstCapacity</span>)

	<span style=color:#75715e>// Update with the latest calculation anyway.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ExcessBurstCapacity</span> = <span style=color:#a6e22e>sRes</span>.<span style=color:#a6e22e>ExcessBurstCapacity</span>
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ret</span>
}
</code></pre></div><p>然后调用Inform函数，这里的watcher函数就是将此事件通知到workQueue来进行后续处理。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Inform sends an update to the registered watcher function, if it is set.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiScaler</span>) <span style=color:#a6e22e>Inform</span>(<span style=color:#a6e22e>event</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NamespacedName</span>) <span style=color:#66d9ef>bool</span> {
   <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>watcherMutex</span>.<span style=color:#a6e22e>RLock</span>()
   <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>watcherMutex</span>.<span style=color:#a6e22e>RUnlock</span>()

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>watcher</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>watcher</span>(<span style=color:#a6e22e>event</span>)
      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
   }
   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
}
<span style=color:#75715e>// 上面函数中的m.watcher就是对应此函数，在pkg/reconciler/autoscaling/kpa/controller.go文件`NewController`函数中被赋值的
</span><span style=color:#75715e>// EnqueueKey takes a namespace/name string and puts it onto the work queue.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Impl</span>) <span style=color:#a6e22e>EnqueueKey</span>(<span style=color:#a6e22e>key</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NamespacedName</span>) {
	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workQueue</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>key</span>)

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Desugar</span>(); <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Core</span>().<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>zapcore</span>.<span style=color:#a6e22e>DebugLevel</span>) {
		<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Adding to queue %s (depth: %d)&#34;</span>, <span style=color:#a6e22e>safeKey</span>(<span style=color:#a6e22e>key</span>), <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workQueue</span>.<span style=color:#a6e22e>Len</span>()),
			<span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>logkey</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>String</span>()))
	}
}
</code></pre></div><p>Worker queue的内容最终会在processNextWorkItem函数中消费。这个函数就是一个集散中心是个通用的函数，每个crd都会有一个对应的controller实例，这里核心就是对<code>c.Reconciler.Reconcile</code>函数的调用，这个函数会根据具体情况决定后续执行<code>ReconcileKind</code>还是销毁后的清理还是观察。在当前情况下会转到kpa对应的<code>ReconcileKind</code>函数。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// processNextWorkItem will read a single work item off the workqueue and
</span><span style=color:#75715e>// attempt to process it, by calling Reconcile on our Reconciler.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Impl</span>) <span style=color:#a6e22e>processNextWorkItem</span>() <span style=color:#66d9ef>bool</span> {
   <span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>shutdown</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workQueue</span>.<span style=color:#a6e22e>Get</span>()
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>shutdown</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
   }
   <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>obj</span>.(<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NamespacedName</span>)
   <span style=color:#a6e22e>keyStr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>safeKey</span>(<span style=color:#a6e22e>key</span>)

   <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Processing from queue %s (depth: %d)&#34;</span>, <span style=color:#a6e22e>safeKey</span>(<span style=color:#a6e22e>key</span>), <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workQueue</span>.<span style=color:#a6e22e>Len</span>())

   <span style=color:#a6e22e>startTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
   <span style=color:#75715e>// Send the metrics for the current queue depth
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>statsReporter</span>.<span style=color:#a6e22e>ReportQueueDepth</span>(int64(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workQueue</span>.<span style=color:#a6e22e>Len</span>()))

   <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
   <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
      <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>trueString</span>
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
         <span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>falseString</span>
      }
      <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>statsReporter</span>.<span style=color:#a6e22e>ReportReconcile</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>startTime</span>), <span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>key</span>)

      <span style=color:#75715e>// We call Done here so the workqueue knows we have finished
</span><span style=color:#75715e></span>      <span style=color:#75715e>// processing this item. We also must remember to call Forget if
</span><span style=color:#75715e></span>      <span style=color:#75715e>// reconcile succeeds. If a transient error occurs, we do not call
</span><span style=color:#75715e></span>      <span style=color:#75715e>// Forget and put the item back to the queue with an increased
</span><span style=color:#75715e></span>      <span style=color:#75715e>// delay.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workQueue</span>.<span style=color:#a6e22e>Done</span>(<span style=color:#a6e22e>key</span>)
   }()

   <span style=color:#75715e>// Embed the key into the logger and attach that to the context we pass
</span><span style=color:#75715e></span>   <span style=color:#75715e>// to the Reconciler.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>With</span>(<span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>logkey</span>.<span style=color:#a6e22e>TraceID</span>, <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>NewString</span>()), <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>logkey</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>keyStr</span>))
   <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logging</span>.<span style=color:#a6e22e>WithLogger</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>logger</span>)

   <span style=color:#75715e>// Run Reconcile, passing it the namespace/name string of the
</span><span style=color:#75715e></span>   <span style=color:#75715e>// resource to be synced.
</span><span style=color:#75715e></span>   <span style=color:#75715e>// 这个函数主要是根据节点是否是leader及是否是删除事件决定需要应用的函数是什么
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Reconciler</span>.<span style=color:#a6e22e>Reconcile</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>keyStr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>handleErr</span>(<span style=color:#a6e22e>logger</span>, <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>startTime</span>)
      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
   }

   <span style=color:#75715e>// Finally, if no error occurs we Forget this item so it does not
</span><span style=color:#75715e></span>   <span style=color:#75715e>// have any delay when another change happens.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>workQueue</span>.<span style=color:#a6e22e>Forget</span>(<span style=color:#a6e22e>key</span>)
   <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infow</span>(<span style=color:#e6db74>&#34;Reconcile succeeded&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#e6db74>&#34;duration&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>startTime</span>)))

   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
}
</code></pre></div><p>后续会调用kpa（以实际缩放类型为准，如果缩放类型是kpa的话）的<code>ReconcileKind</code>，这个函数比较长，我们划一下重点：<code>ReconcileSKS</code>、<code>reconcileDecider</code>、<code>ReconcileMetric</code>、<code>want, err := c.scaler.scale(ctx, pa, sks, decider.Status.DesiredScale)</code>、<code>computeStatus</code>.其中 <code>ReconcileSKS</code>、<code>reconcileDecider</code>、<code>ReconcileMetric</code>都是对对应crd的更新，只有一个例外Decider它不是个实实在在创建到k8s的crd。其中<code>computeStatus</code>其实也是对crd的更新，只不过是更新<code>PodAutoscaler</code>.那么到目前还没有提到的<code>want, err := c.scaler.scale(ctx, pa, sks, decider.Status.DesiredScale)</code>函数就是做了实际对deployment进行缩放的逻辑。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Reconciler</span>) <span style=color:#a6e22e>ReconcileKind</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pa</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>autoscalingv1alpha1</span>.<span style=color:#a6e22e>PodAutoscaler</span>) <span style=color:#a6e22e>pkgreconciler</span>.<span style=color:#a6e22e>Event</span> {
   <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
   <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()

   <span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logging</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>)

   <span style=color:#75715e>// We need the SKS object in order to optimize scale to zero
</span><span style=color:#75715e></span>   <span style=color:#75715e>// performance. It is OK if SKS is nil at this point.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>sksName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>anames</span>.<span style=color:#a6e22e>SKS</span>(<span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Name</span>)
   <span style=color:#a6e22e>sks</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>SKSLister</span>.<span style=color:#a6e22e>ServerlessServices</span>(<span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Namespace</span>).<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>sksName</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>IsNotFound</span>(<span style=color:#a6e22e>err</span>) {
      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Warnw</span>(<span style=color:#e6db74>&#34;Error retrieving SKS for Scaler&#34;</span>, <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>))
   }

   <span style=color:#75715e>// Having an SKS and its PrivateServiceName is a prerequisite for all upcoming steps.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sks</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>sks</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>PrivateServiceName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
      <span style=color:#75715e>// Before we can reconcile decider and get real number of activators
</span><span style=color:#75715e></span>      <span style=color:#75715e>// we start with default of 2.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>ReconcileSKS</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>nv1alpha1</span>.<span style=color:#a6e22e>SKSOperationModeServe</span>, <span style=color:#a6e22e>minActivators</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error reconciling SKS: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
      }
      <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>MarkSKSNotReady</span>(<span style=color:#a6e22e>noPrivateServiceName</span>) <span style=color:#75715e>// In both cases this is true.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>computeStatus</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>podCounts</span>{<span style=color:#a6e22e>want</span>: <span style=color:#a6e22e>scaleUnknown</span>}, <span style=color:#a6e22e>logger</span>)
      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
   }

   <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>MetricsServiceName</span> = <span style=color:#a6e22e>sks</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>PrivateServiceName</span>
   <span style=color:#a6e22e>decider</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>reconcileDecider</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error reconciling Decider: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
   }

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>ReconcileMetric</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>resolveScrapeTarget</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error reconciling Metric: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
   }

   <span style=color:#75715e>// Get the appropriate current scale from the metric, and right size
</span><span style=color:#75715e></span>   <span style=color:#75715e>// the scaleTargetRef based on it.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>scaler</span>.<span style=color:#a6e22e>scale</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>sks</span>, <span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>DesiredScale</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error scaling target: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
   }

   <span style=color:#75715e>// 这里开始计算sks的模式应该是什么，当pod正常的时候就serve模式。模式代表的含义？
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>mode</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nv1alpha1</span>.<span style=color:#a6e22e>SKSOperationModeServe</span>
   <span style=color:#75715e>// We put activator in the serving path in the following cases:
</span><span style=color:#75715e></span>   <span style=color:#75715e>// 1. The revision is scaled to 0:
</span><span style=color:#75715e></span>   <span style=color:#75715e>//   a. want == 0
</span><span style=color:#75715e></span>   <span style=color:#75715e>//   b. want == -1 &amp;&amp; PA is inactive (Autoscaler has no previous knowledge of
</span><span style=color:#75715e></span>   <span style=color:#75715e>//       this revision, e.g. after a restart) but PA status is inactive (it was
</span><span style=color:#75715e></span>   <span style=color:#75715e>//       already scaled to 0).
</span><span style=color:#75715e></span>   <span style=color:#75715e>// 2. The excess burst capacity is negative.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>want</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ExcessBurstCapacity</span> &lt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>want</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>scaleUnknown</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>IsInactive</span>() {
      <span style=color:#a6e22e>mode</span> = <span style=color:#a6e22e>nv1alpha1</span>.<span style=color:#a6e22e>SKSOperationModeProxy</span>
   }

   <span style=color:#75715e>// 根据reversion label获取所有的pod，根据每个pod的状态计算每种状态的pod有多少个。
</span><span style=color:#75715e></span>   <span style=color:#75715e>// Compare the desired and observed resources to determine our situation.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>podCounter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resourceutil</span>.<span style=color:#a6e22e>NewPodAccessor</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>podsLister</span>, <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Labels</span>[<span style=color:#a6e22e>serving</span>.<span style=color:#a6e22e>RevisionLabelKey</span>])
   <span style=color:#a6e22e>ready</span>, <span style=color:#a6e22e>notReady</span>, <span style=color:#a6e22e>pending</span>, <span style=color:#a6e22e>terminating</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>podCounter</span>.<span style=color:#a6e22e>PodCountsByState</span>()
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error getting pod counts: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
   }

   <span style=color:#75715e>// numActivators就是activator的数量
</span><span style=color:#75715e></span>   <span style=color:#75715e>// Determine the amount of activators to put into the routing path.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>numActivators</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>computeNumActivators</span>(<span style=color:#a6e22e>ready</span>, <span style=color:#a6e22e>decider</span>)

   <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;SKS should be in %s mode: want = %d, ebc = %d, #act&#39;s = %d PA Inactive? = %v&#34;</span>,
      <span style=color:#a6e22e>mode</span>, <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ExcessBurstCapacity</span>, <span style=color:#a6e22e>numActivators</span>,
      <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>IsInactive</span>())

   <span style=color:#75715e>// 创建或者更新sks
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>sks</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>ReconcileSKS</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>mode</span>, <span style=color:#a6e22e>numActivators</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error reconciling SKS: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
   }
   <span style=color:#75715e>// Propagate service name.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ServiceName</span> = <span style=color:#a6e22e>sks</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ServiceName</span>

   <span style=color:#75715e>// If SKS is not ready — ensure we&#39;re not becoming ready.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sks</span>.<span style=color:#a6e22e>IsReady</span>() {
      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;SKS is ready, marking SKS status ready&#34;</span>)
      <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>MarkSKSReady</span>()
   } <span style=color:#66d9ef>else</span> {
      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;SKS is not ready, marking SKS status not ready&#34;</span>)
      <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>MarkSKSNotReady</span>(<span style=color:#a6e22e>sks</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>GetCondition</span>(<span style=color:#a6e22e>nv1alpha1</span>.<span style=color:#a6e22e>ServerlessServiceConditionReady</span>).<span style=color:#a6e22e>GetMessage</span>())
   }

   <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;PA scale got=%d, want=%d, desiredPods=%d ebc=%d&#34;</span>, <span style=color:#a6e22e>ready</span>, <span style=color:#a6e22e>want</span>,
      <span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>DesiredScale</span>, <span style=color:#a6e22e>decider</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ExcessBurstCapacity</span>)

   <span style=color:#a6e22e>pc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>podCounts</span>{
      <span style=color:#a6e22e>want</span>:        int(<span style=color:#a6e22e>want</span>),
      <span style=color:#a6e22e>ready</span>:       <span style=color:#a6e22e>ready</span>,
      <span style=color:#a6e22e>notReady</span>:    <span style=color:#a6e22e>notReady</span>,
      <span style=color:#a6e22e>pending</span>:     <span style=color:#a6e22e>pending</span>,
      <span style=color:#a6e22e>terminating</span>: <span style=color:#a6e22e>terminating</span>,
   }
   <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Observed pod counts=%#v&#34;</span>, <span style=color:#a6e22e>pc</span>)
   <span style=color:#a6e22e>computeStatus</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>pc</span>, <span style=color:#a6e22e>logger</span>)
   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p><code>ReconcileMetric</code>定义在pkg/reconciler/autoscaling/reconciler.go文件中。根据kpa和scaler配置计算出目标metrics的crd。在配置没有变更的情况下，不会有更新，所以这个函数在大多数情况下是不会变动的。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// ReconcileMetric reconciles a metric instance out of the given PodAutoscaler to control metric collection.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Base</span>) <span style=color:#a6e22e>ReconcileMetric</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pa</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>autoscalingv1alpha1</span>.<span style=color:#a6e22e>PodAutoscaler</span>, <span style=color:#a6e22e>metricSN</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
   <span style=color:#a6e22e>desiredMetric</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resources</span>.<span style=color:#a6e22e>MakeMetric</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>metricSN</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>).<span style=color:#a6e22e>Autoscaler</span>)
   <span style=color:#a6e22e>metric</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>MetricLister</span>.<span style=color:#a6e22e>Metrics</span>(<span style=color:#a6e22e>desiredMetric</span>.<span style=color:#a6e22e>Namespace</span>).<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>desiredMetric</span>.<span style=color:#a6e22e>Name</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>IsNotFound</span>(<span style=color:#a6e22e>err</span>) {
      <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Client</span>.<span style=color:#a6e22e>AutoscalingV1alpha1</span>().<span style=color:#a6e22e>Metrics</span>(<span style=color:#a6e22e>desiredMetric</span>.<span style=color:#a6e22e>Namespace</span>).<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>desiredMetric</span>, <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>CreateOptions</span>{})
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error creating metric: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
      }
   } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error fetching metric: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
   } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>IsControlledBy</span>(<span style=color:#a6e22e>metric</span>, <span style=color:#a6e22e>pa</span>) {
      <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>MarkResourceNotOwned</span>(<span style=color:#e6db74>&#34;Metric&#34;</span>, <span style=color:#a6e22e>desiredMetric</span>.<span style=color:#a6e22e>Name</span>)
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;PA: %s does not own Metric: %s&#34;</span>, <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>desiredMetric</span>.<span style=color:#a6e22e>Name</span>)
   } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>equality</span>.<span style=color:#a6e22e>Semantic</span>.<span style=color:#a6e22e>DeepEqual</span>(<span style=color:#a6e22e>desiredMetric</span>.<span style=color:#a6e22e>Spec</span>, <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>Spec</span>) {
      <span style=color:#a6e22e>want</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>DeepCopy</span>()
      <span style=color:#a6e22e>want</span>.<span style=color:#a6e22e>Spec</span> = <span style=color:#a6e22e>desiredMetric</span>.<span style=color:#a6e22e>Spec</span>
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Client</span>.<span style=color:#a6e22e>AutoscalingV1alpha1</span>().<span style=color:#a6e22e>Metrics</span>(<span style=color:#a6e22e>desiredMetric</span>.<span style=color:#a6e22e>Namespace</span>).<span style=color:#a6e22e>Update</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>UpdateOptions</span>{}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error updating metric: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
      }
   }

   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p><code>scale</code>定义在<code>pkg/reconciler/autoscaling/kpa/scaler.go</code>中，功能是对目标进行缩放，主要是计算各种边界状态，并根据实际情况调用缩容到0和进行缩放的函数。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// scale attempts to scale the given PA&#39;s target reference to the desired scale.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ks</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>scaler</span>) <span style=color:#a6e22e>scale</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pa</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>autoscalingv1alpha1</span>.<span style=color:#a6e22e>PodAutoscaler</span>, <span style=color:#a6e22e>sks</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nv1a1</span>.<span style=color:#a6e22e>ServerlessService</span>, <span style=color:#a6e22e>desiredScale</span> <span style=color:#66d9ef>int32</span>) (<span style=color:#66d9ef>int32</span>, <span style=color:#66d9ef>error</span>) {
   <span style=color:#a6e22e>asConfig</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>).<span style=color:#a6e22e>Autoscaler</span>
   <span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logging</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>)

   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>desiredScale</span> &lt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>IsActivating</span>() {
      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;Metrics are not yet being collected.&#34;</span>)
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>nil</span>
   }

   <span style=color:#a6e22e>min</span>, <span style=color:#a6e22e>max</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>ScaleBounds</span>(<span style=color:#a6e22e>asConfig</span>)
   <span style=color:#a6e22e>initialScale</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kparesources</span>.<span style=color:#a6e22e>GetInitialScale</span>(<span style=color:#a6e22e>asConfig</span>, <span style=color:#a6e22e>pa</span>)
   <span style=color:#75715e>// Log reachability as quoted string, since default value is &#34;&#34;.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;MinScale = %d, MaxScale = %d, InitialScale = %d, DesiredScale = %d Reachable = %q&#34;</span>,
      <span style=color:#a6e22e>min</span>, <span style=color:#a6e22e>max</span>, <span style=color:#a6e22e>initialScale</span>, <span style=color:#a6e22e>desiredScale</span>, <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Reachability</span>)
   <span style=color:#75715e>// If initial scale has been attained, ignore the initialScale altogether.
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>initialScale</span> &gt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>IsScaleTargetInitialized</span>() {
      <span style=color:#75715e>// Ignore initial scale if minScale &gt;= initialScale.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>min</span> &lt; <span style=color:#a6e22e>initialScale</span> {
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Adjusting min to meet the initial scale: %d -&gt; %d&#34;</span>, <span style=color:#a6e22e>min</span>, <span style=color:#a6e22e>initialScale</span>)
      }
      <span style=color:#a6e22e>min</span> = <span style=color:#a6e22e>intMax</span>(<span style=color:#a6e22e>initialScale</span>, <span style=color:#a6e22e>min</span>)
   }
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newScale</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>applyBounds</span>(<span style=color:#a6e22e>min</span>, <span style=color:#a6e22e>max</span>, <span style=color:#a6e22e>desiredScale</span>); <span style=color:#a6e22e>newScale</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>desiredScale</span> {
      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;Adjusting desiredScale to meet the min and max bounds before applying: %d -&gt; %d&#34;</span>, <span style=color:#a6e22e>desiredScale</span>, <span style=color:#a6e22e>newScale</span>)
      <span style=color:#a6e22e>desiredScale</span> = <span style=color:#a6e22e>newScale</span>
   }

   <span style=color:#a6e22e>desiredScale</span>, <span style=color:#a6e22e>shouldApplyScale</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>handleScaleToZero</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>sks</span>, <span style=color:#a6e22e>desiredScale</span>)
   <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>shouldApplyScale</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>nil</span>
   }

   <span style=color:#75715e>// 获取deployment
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>ps</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resources</span>.<span style=color:#a6e22e>GetScaleResource</span>(<span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>ScaleTargetRef</span>, <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>listerFactory</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get scale target %v: %w&#34;</span>, <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>ScaleTargetRef</span>, <span style=color:#a6e22e>err</span>)
   }

   <span style=color:#a6e22e>currentScale</span> <span style=color:#f92672>:=</span> int32(<span style=color:#ae81ff>1</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Replicas</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>currentScale</span> = <span style=color:#f92672>*</span><span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Replicas</span>
   }
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>desiredScale</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>currentScale</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>nil</span>
   }

   <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Scaling from %d to %d&#34;</span>, <span style=color:#a6e22e>currentScale</span>, <span style=color:#a6e22e>desiredScale</span>)
   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>applyScale</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>desiredScale</span>, <span style=color:#a6e22e>ps</span>)
}
</code></pre></div><h4 id=对deployment副本数进行修改>对deployment副本数进行修改</h4>
<p>执行缩容到0的逻辑，todo仔细看看需要缩容到0的时候的逻辑判断</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ks</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>scaler</span>) <span style=color:#a6e22e>handleScaleToZero</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pa</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>autoscalingv1alpha1</span>.<span style=color:#a6e22e>PodAutoscaler</span>,
   <span style=color:#a6e22e>sks</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nv1a1</span>.<span style=color:#a6e22e>ServerlessService</span>, <span style=color:#a6e22e>desiredScale</span> <span style=color:#66d9ef>int32</span>) (<span style=color:#66d9ef>int32</span>, <span style=color:#66d9ef>bool</span>) {
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>desiredScale</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>true</span>
   }

   <span style=color:#75715e>// We should only scale to zero when three of the following conditions are true:
</span><span style=color:#75715e></span>   <span style=color:#75715e>//   a) enable-scale-to-zero from configmap is true
</span><span style=color:#75715e></span>   <span style=color:#75715e>//   b) The PA has been active for at least the stable window, after which it
</span><span style=color:#75715e></span>   <span style=color:#75715e>//       gets marked inactive, and
</span><span style=color:#75715e></span>   <span style=color:#75715e>//   c) the PA has been backed by the Activator for at least the grace period
</span><span style=color:#75715e></span>   <span style=color:#75715e>//      of time.
</span><span style=color:#75715e></span>   <span style=color:#75715e>//  Alternatively, if (a) and the revision did not succeed to activate in
</span><span style=color:#75715e></span>   <span style=color:#75715e>//  `activationTimeout` time -- also scale it to 0.
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>cfgs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>)
   <span style=color:#a6e22e>cfgAS</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cfgs</span>.<span style=color:#a6e22e>Autoscaler</span>

   <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>cfgAS</span>.<span style=color:#a6e22e>EnableScaleToZero</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>true</span>
   }
   <span style=color:#a6e22e>cfgD</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cfgs</span>.<span style=color:#a6e22e>Deployment</span>
   <span style=color:#a6e22e>activationTimeout</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cfgD</span>.<span style=color:#a6e22e>ProgressDeadline</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>activationTimeoutBuffer</span>

   <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
   <span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logging</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>)
   <span style=color:#66d9ef>switch</span> {
   <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>IsActivating</span>(): <span style=color:#75715e>// Active=Unknown
</span><span style=color:#75715e></span>      <span style=color:#75715e>// If we are stuck activating for longer than our progress deadline, presume we cannot succeed and scale to 0.
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>CanFailActivation</span>(<span style=color:#a6e22e>now</span>, <span style=color:#a6e22e>activationTimeout</span>) {
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Activation has timed out after &#34;</span>, <span style=color:#a6e22e>activationTimeout</span>)
         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>true</span>
      }
      <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>enqueueCB</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>activationTimeout</span>)
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>scaleUnknown</span>, <span style=color:#66d9ef>false</span>
   <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>IsActive</span>(): <span style=color:#75715e>// Active=True
</span><span style=color:#75715e></span>      <span style=color:#75715e>// Don&#39;t scale-to-zero if the PA is active
</span><span style=color:#75715e></span>      <span style=color:#75715e>// but return `(0, false)` to mark PA inactive, instead.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>sw</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>aresources</span>.<span style=color:#a6e22e>StableWindow</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>cfgAS</span>)
      <span style=color:#a6e22e>af</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ActiveFor</span>(<span style=color:#a6e22e>now</span>)
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>af</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>sw</span> {
         <span style=color:#75715e>// If SKS is in proxy mode, then there is high probability
</span><span style=color:#75715e></span>         <span style=color:#75715e>// of SKS not changing its spec/status and thus not triggering
</span><span style=color:#75715e></span>         <span style=color:#75715e>// a new reconciliation of PA.
</span><span style=color:#75715e></span>         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sks</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Mode</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>nv1a1</span>.<span style=color:#a6e22e>SKSOperationModeProxy</span> {
            <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;SKS is already in proxy mode, auto-re-enqueue PA&#34;</span>)
            <span style=color:#75715e>// Long enough to ensure current iteration is finished.
</span><span style=color:#75715e></span>            <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>enqueueCB</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#ae81ff>3</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
         }
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Can deactivate PA, was active for &#34;</span>, <span style=color:#a6e22e>af</span>)
         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>false</span>
      }
      <span style=color:#75715e>// Otherwise, scale down to at most 1 for the remainder of the idle period and then
</span><span style=color:#75715e></span>      <span style=color:#75715e>// reconcile PA again.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Sleeping additionally for %v before can scale to 0&#34;</span>, <span style=color:#a6e22e>sw</span><span style=color:#f92672>-</span><span style=color:#a6e22e>af</span>)
      <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>enqueueCB</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>sw</span><span style=color:#f92672>-</span><span style=color:#a6e22e>af</span>)
      <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>true</span>
   <span style=color:#66d9ef>default</span>: <span style=color:#75715e>// Active=False
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>var</span> (
         <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
         <span style=color:#a6e22e>r</span>   = <span style=color:#66d9ef>true</span>
      )

      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resolveTBC</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pa</span>) <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
         <span style=color:#75715e>// if TBC is -1 activator is guaranteed to already be in the path.
</span><span style=color:#75715e></span>         <span style=color:#75715e>// Otherwise, probe to make sure Activator is in path.
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>activatorProbe</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>transport</span>)
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Probing activator = %v, err = %v&#34;</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span>)
      }

      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span> {
         <span style=color:#75715e>// This enforces that the revision has been backed by the Activator for at least
</span><span style=color:#75715e></span>         <span style=color:#75715e>// ScaleToZeroGracePeriod time.
</span><span style=color:#75715e></span>         <span style=color:#75715e>// And at least ScaleToZeroPodRetentionPeriod since PA became inactive.
</span><span style=color:#75715e></span>
         <span style=color:#75715e>// Most conservative check, if it passes we&#39;re good.
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>lastPodTimeout</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lastPodRetention</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>cfgAS</span>)
         <span style=color:#a6e22e>lastPodMaxTimeout</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>durationMax</span>(<span style=color:#a6e22e>cfgAS</span>.<span style=color:#a6e22e>ScaleToZeroGracePeriod</span>, <span style=color:#a6e22e>lastPodTimeout</span>)
         <span style=color:#75715e>// If we have been inactive for this long, we can scale to 0!
</span><span style=color:#75715e></span>         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>InactiveFor</span>(<span style=color:#a6e22e>now</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>lastPodMaxTimeout</span> {
            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>true</span>
         }

         <span style=color:#75715e>// Now check last pod retention timeout. Since it&#39;s a hard deadline, regardless
</span><span style=color:#75715e></span>         <span style=color:#75715e>// of network programming state we should circle back after that time period.
</span><span style=color:#75715e></span>         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastPodTimeout</span> &gt; <span style=color:#ae81ff>0</span> {
            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>inactiveTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>InactiveFor</span>(<span style=color:#a6e22e>now</span>); <span style=color:#a6e22e>inactiveTime</span> &lt; <span style=color:#a6e22e>lastPodTimeout</span> {
               <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Can&#39;t scale to 0; InactiveFor %v &lt; ScaleToZeroPodRetentionPeriod = %v&#34;</span>,
                  <span style=color:#a6e22e>inactiveTime</span>, <span style=color:#a6e22e>lastPodTimeout</span>)
               <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>enqueueCB</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>lastPodTimeout</span><span style=color:#f92672>-</span><span style=color:#a6e22e>inactiveTime</span>)
               <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>false</span>
            }
            <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;Last pod timeout satisfied&#34;</span>)
         }

         <span style=color:#75715e>// Otherwise check how long SKS was in proxy mode.
</span><span style=color:#75715e></span>         <span style=color:#75715e>// Compute the difference between time we&#39;ve been proxying with the timeout.
</span><span style=color:#75715e></span>         <span style=color:#75715e>// If it&#39;s positive, that&#39;s the time we need to sleep, if negative -- we
</span><span style=color:#75715e></span>         <span style=color:#75715e>// can scale to zero.
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>pf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sks</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>ProxyFor</span>()
         <span style=color:#a6e22e>to</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cfgAS</span>.<span style=color:#a6e22e>ScaleToZeroGracePeriod</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>pf</span>
         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>to</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> {
            <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Fast path scaling to 0, in proxy mode for: &#34;</span>, <span style=color:#a6e22e>pf</span>)
            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>true</span>
         }

         <span style=color:#75715e>// Re-enqueue the PA for reconciliation with timeout of `to` to make sure we wait
</span><span style=color:#75715e></span>         <span style=color:#75715e>// long enough.
</span><span style=color:#75715e></span>         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Enqueueing PA after &#34;</span>, <span style=color:#a6e22e>to</span>)
         <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>enqueueCB</span>(<span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>to</span>)
         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>false</span>
      }

      <span style=color:#75715e>// Otherwise (any prober failure) start the async probe.
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;PA is not yet backed by activator, cannot scale to zero&#34;</span>)
      <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>probeManager</span>.<span style=color:#a6e22e>Offer</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>paToProbeTarget</span>(<span style=color:#a6e22e>pa</span>), <span style=color:#a6e22e>pa</span>, <span style=color:#a6e22e>probePeriod</span>, <span style=color:#a6e22e>probeTimeout</span>, <span style=color:#a6e22e>probeOptions</span><span style=color:#f92672>...</span>) {
         <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Probe for revision is already in flight&#34;</span>)
      }
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desiredScale</span>, <span style=color:#66d9ef>false</span>
   }
}
</code></pre></div><p>应用缩放，其核心的逻辑就是获取<code>PodAutoscaler</code>引用的deployment，并修改副本数量，如果期望副本数不一致就创建patch来修改对应的deployment。</p>
<p>ScaleTargetRef指向的是deployment，获取dep应用计算出来的patch，其中patch的内容就是将deployment的Replicas数量改为希望的数量，然后进行patch。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ks</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>scaler</span>) <span style=color:#a6e22e>applyScale</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pa</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>autoscalingv1alpha1</span>.<span style=color:#a6e22e>PodAutoscaler</span>, <span style=color:#a6e22e>desiredScale</span> <span style=color:#66d9ef>int32</span>,
   <span style=color:#a6e22e>ps</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>autoscalingv1alpha1</span>.<span style=color:#a6e22e>PodScalable</span>) <span style=color:#66d9ef>error</span> {
   <span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logging</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>ctx</span>)

   <span style=color:#75715e>// 获取引用的deployment
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>gvr</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resources</span>.<span style=color:#a6e22e>ScaleResourceArguments</span>(<span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>ScaleTargetRef</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
   }

   <span style=color:#a6e22e>psNew</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>DeepCopy</span>()
   <span style=color:#a6e22e>psNew</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Replicas</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>desiredScale</span>
   <span style=color:#a6e22e>patch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>duck</span>.<span style=color:#a6e22e>CreatePatch</span>(<span style=color:#a6e22e>ps</span>, <span style=color:#a6e22e>psNew</span>)
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
   }
   <span style=color:#a6e22e>patchBytes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>MarshalJSON</span>()
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
   }

   <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ks</span>.<span style=color:#a6e22e>dynamicClient</span>.<span style=color:#a6e22e>Resource</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>gvr</span>).<span style=color:#a6e22e>Namespace</span>(<span style=color:#a6e22e>pa</span>.<span style=color:#a6e22e>Namespace</span>).<span style=color:#a6e22e>Patch</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>JSONPatchType</span>,
      <span style=color:#a6e22e>patchBytes</span>, <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>PatchOptions</span>{})
   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to apply scale %d to scale target %s: %w&#34;</span>, <span style=color:#a6e22e>desiredScale</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>err</span>)
   }

   <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;Successfully scaled to &#34;</span>, <span style=color:#a6e22e>desiredScale</span>)
   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>参考资料：</p>
<p><a href=https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/>给容器配置存活、就绪和启动探测器</a></p>
<p><a href></a></p>
<div class="text-muted mt-5 pt-3 border-top">
</div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.f8dc12214b1b557b8ee4603ff35df42ebeef990cf05109190b758b04eac03307.js integrity="sha256-+NwSIUsbVXuO5GA/8130Lr7vmQzwUQkZC3WLBOrAMwc=" crossorigin=anonymous></script>
</body>
</html>